<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>foldspace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    :root {
      /*
       * Subterranean Precision
       * Deep blue-black backgrounds with cold undertone.
       * Amber: brand accent, used sparingly — one indicator light, not paint.
       * Teal: signal color — active states, user interactions, status.
       * Everything else: metallic gray-blue, barely-there borders.
       */
      --bg: #060810;
      --bg-surface: #0a0c14;
      --bg-elevated: #0f1219;
      --bg-hover: #13161f;
      --bg-inset: #04050a;
      --border: rgba(255,255,255,0.06);
      --border-bright: rgba(255,255,255,0.10);

      --text: #94a0b4;
      --text-bright: #cdd3de;
      --text-muted: #647080;
      --text-dim: #3a4558;

      /* Amber — brand, warmth, sparingly */
      --amber: #b88a3e;
      --amber-dim: rgba(184,138,62,0.08);
      --amber-bright: #d4a650;

      /* Teal — signal, interaction, status */
      --teal: #3a9e8f;
      --teal-dim: rgba(58,158,143,0.07);
      --teal-bright: #52b8a8;

      /* Signal */
      --green: #3a9e6a;
      --red: #9e3a3a;
      --yellow: #9e8a3a;

      --font-sans: 'Instrument Sans', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      --font-mono: 'IBM Plex Mono', 'SF Mono', monospace;
      --r: 4px;
      --r-lg: 6px;
      --ease: cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Faint noise texture — looking through facility glass */
    body::after {
      content: '';
      position: fixed; inset: 0; z-index: 9999;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      opacity: 0.012;
      mix-blend-mode: overlay;
    }

    #app { display: flex; height: 100vh; flex-direction: column; }

    /* === Tab Bar === */
    #tab-bar {
      display: flex;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      min-height: 36px;
      align-items: stretch;
      flex-shrink: 0;
    }
    #tab-bar-brand {
      display: flex; align-items: center; padding: 0 16px;
      border-right: 1px solid var(--border); flex-shrink: 0;
      color: var(--text-muted); font-size: 12px; font-weight: 500;
      font-family: var(--font-mono); letter-spacing: 0.12em;
      transition: color 0.3s var(--ease);
    }
    #tab-bar-brand:hover { color: var(--amber); }
    #tab-bar-tabs { display: flex; flex: 1; overflow-x: auto; }
    #tab-bar-tabs::-webkit-scrollbar { height: 0; }

    .tab {
      padding: 0 16px; font-size: 13px; font-weight: 500;
      color: var(--text-muted); border-bottom: 1px solid transparent;
      cursor: pointer; white-space: nowrap; display: flex;
      align-items: center; gap: 7px; transition: all 0.15s var(--ease);
      user-select: none;
    }
    .tab:hover { color: var(--text); background: var(--bg-hover); }
    .tab.active { color: var(--teal); border-bottom-color: var(--teal); }
    .tab-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--teal); flex-shrink: 0; opacity: 0.7; }
    .tab-dot.ended { background: var(--text-dim); opacity: 0.4; }
    .tab-badge {
      font-size: 10px; background: var(--teal-dim); color: var(--teal);
      padding: 0 5px; border-radius: 4px; font-weight: 600;
      font-family: var(--font-mono); font-variant-numeric: tabular-nums;
    }

    /* === Main Layout === */
    #main { display: flex; flex: 1; overflow: hidden; }
    #content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* === Session Header === */
    .session-header {
      padding: 12px 36px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sh-row1 { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; flex-wrap: wrap; }
    .sh-cwd {
      font-size: 13px; font-weight: 500; color: var(--text-bright);
      font-family: var(--font-mono); letter-spacing: -0.01em;
    }
    .sh-pill {
      font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 3px;
      letter-spacing: 0.05em; text-transform: uppercase;
      font-family: var(--font-mono);
    }
    .sh-pill.model { background: var(--teal-dim); color: var(--teal); border: 1px solid rgba(58,158,143,0.1); }
    .sh-pill.perm { background: rgba(255,255,255,0.02); color: var(--text-dim); border: 1px solid var(--border); }
    .sh-pill.source { background: rgba(255,255,255,0.02); color: var(--text-muted); border: 1px solid var(--border); }
    .sh-grid {
      display: flex; flex-wrap: wrap; gap: 3px 16px; font-size: 12px;
    }
    .sh-grid .mi { display: flex; gap: 4px; align-items: baseline; }
    .sh-grid .ml { color: var(--text-dim); font-weight: 500; font-size: 11px; }
    .sh-grid .mv { color: var(--text-muted); font-family: var(--font-mono); font-size: 11px; font-variant-numeric: tabular-nums; }

    /* Git status row */
    .sh-git {
      display: flex; align-items: center; gap: 10px; margin-top: 5px;
      font-family: var(--font-mono); font-size: 11px; font-weight: 500;
      letter-spacing: 0.01em;
    }
    .sh-git-branch {
      color: var(--teal); overflow: hidden; text-overflow: ellipsis;
      white-space: nowrap; max-width: 200px;
    }
    .sh-git-sync { color: var(--text-muted); }
    .sh-git-sync .ahead { color: var(--teal); }
    .sh-git-sync .behind { color: var(--amber); }
    .sh-git-files { display: flex; gap: 8px; }
    .sh-git-files .gs { letter-spacing: 0; }
    .sh-git-files .gs-staged { color: var(--teal); }
    .sh-git-files .gs-modified { color: var(--amber); }
    .sh-git-files .gs-untracked { color: var(--text-muted); }
    .sh-git-files .gs-conflicted { color: var(--red); }
    .sh-git-clean { color: var(--teal); opacity: 0.5; font-size: 10px; }
    .sh-git-dot {
      width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0;
    }
    .sh-git-dot.clean { background: var(--teal); opacity: 0.5; }
    .sh-git-dot.dirty { background: var(--amber); opacity: 0.7; }
    .sh-git-dot.conflict { background: var(--red); opacity: 0.7; }

    /* === Response Stream === */
    #responses-area { flex: 1; overflow-y: auto; padding: 24px 36px 80px; }

    .response-entry {
      margin-bottom: 28px;
      animation: fadeIn 0.2s var(--ease);
    }
    .response-entry:not(:last-child) {
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .response-meta {
      font-size: 11px; color: var(--text-dim); margin-bottom: 14px;
      display: flex; gap: 8px; align-items: center;
      font-family: var(--font-mono); font-weight: 500; letter-spacing: 0.02em;
    }
    .response-num {
      color: var(--teal); opacity: 0.6;
    }

    /* === Markdown === */
    .md {
      font-size: 15px; line-height: 1.75; color: var(--text);
      max-width: 720px; word-wrap: break-word;
    }
    .md h1 {
      font-size: 1.4em; font-weight: 700; color: var(--text-bright);
      margin: 28px 0 12px; padding-bottom: 6px;
      border-bottom: 1px solid var(--border); letter-spacing: -0.02em;
    }
    .md h2 {
      font-size: 1.2em; font-weight: 600; color: var(--text-bright);
      margin: 24px 0 10px; padding-bottom: 4px;
      border-bottom: 1px solid var(--border);
    }
    .md h3 { font-size: 1.05em; font-weight: 600; color: var(--text-bright); margin: 18px 0 8px; }
    .md h4 { font-size: 1em; font-weight: 600; color: var(--text); margin: 14px 0 6px; }
    .md p { margin: 9px 0; }
    .md strong { color: var(--text-bright); font-weight: 600; }
    .md em { color: var(--text-muted); font-style: italic; }
    .md a { color: var(--teal); text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.15s; }
    .md a:hover { border-bottom-color: var(--teal); }
    .md hr { border: none; border-top: 1px solid var(--border); margin: 22px 0; }

    .md code {
      background: var(--bg-elevated); padding: 1px 5px; border-radius: 3px;
      font-size: 0.87em; font-family: var(--font-mono); color: var(--text-bright);
      font-weight: 500; border: 1px solid var(--border);
    }

    .md pre {
      background: var(--bg-inset); border: 1px solid var(--border);
      border-radius: var(--r-lg); margin: 14px 0; position: relative;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .md pre code {
      display: block; padding: 14px 16px; overflow-x: auto;
      background: none; color: var(--text); font-size: 13.5px;
      line-height: 1.65; font-weight: 400; border: none;
    }
    .code-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 12px; background: rgba(255,255,255,0.015);
      border-bottom: 1px solid var(--border); font-size: 10px;
    }
    .code-lang { color: var(--text-muted); font-family: var(--font-mono); font-weight: 500; text-transform: lowercase; }
    .copy-btn {
      background: none; border: 1px solid var(--border); border-radius: 3px;
      color: var(--text-muted); font-size: 10px; padding: 2px 8px; cursor: pointer;
      font-family: var(--font-mono); font-weight: 500; transition: all 0.15s var(--ease);
      text-transform: lowercase; letter-spacing: 0.03em;
    }
    .copy-btn:hover { color: var(--text-muted); border-color: var(--border-bright); }
    .copy-btn.copied { color: var(--teal); border-color: rgba(58,158,143,0.3); }

    .md blockquote {
      border-left: 2px solid var(--border-bright); padding: 6px 14px; margin: 12px 0;
      color: var(--text-muted); font-size: 14.5px;
    }
    .md ul, .md ol { padding-left: 20px; margin: 8px 0; }
    .md li { margin: 4px 0; }
    .md li::marker { color: var(--text-dim); }

    .md table { border-collapse: collapse; margin: 14px 0; width: 100%; font-size: 13px; }
    .md th, .md td { border: 1px solid var(--border); padding: 7px 11px; text-align: left; }
    .md th { background: var(--bg-elevated); font-weight: 600; color: var(--text-bright); font-size: 11px; text-transform: uppercase; letter-spacing: 0.03em; }

    /* === Sidebar === */
    #sidebar {
      width: 280px; background: var(--bg-surface); border-left: 1px solid var(--border);
      display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden;
    }
    .sidebar-tabs {
      display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .sidebar-tab {
      flex: 1; padding: 10px; font-size: 11px; font-weight: 600;
      color: var(--text-muted); text-align: center; cursor: pointer;
      text-transform: uppercase; letter-spacing: 0.08em;
      border-bottom: 1px solid transparent; transition: all 0.15s var(--ease);
      user-select: none; font-family: var(--font-mono);
    }
    .sidebar-tab:hover { color: var(--text-muted); }
    .sidebar-tab.active { color: var(--teal); border-bottom-color: var(--teal); }

    .sidebar-panel { flex: 1; overflow-y: auto; display: none; }
    .sidebar-panel.active { display: flex; flex-direction: column; }

    /* Annotations */
    #annotation-list { flex: 1; overflow-y: auto; padding: 8px; }
    .annotation-card {
      background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: var(--r); padding: 10px; margin-bottom: 5px;
      transition: border-color 0.15s var(--ease);
    }
    .annotation-card:hover { border-color: var(--border-bright); }
    .annotation-card .sel {
      font-size: 12.5px; color: var(--text-muted); border-left: 2px solid var(--teal);
      padding-left: 8px; margin-bottom: 6px; font-style: italic;
      max-height: 40px; overflow: hidden; line-height: 1.4;
      opacity: 0.8;
    }
    .annotation-card .cmt { font-size: 13px; color: var(--text); line-height: 1.5; }
    .annotation-card .meta {
      font-size: 10px; color: var(--text-dim); margin-top: 5px;
      display: flex; justify-content: space-between;
      font-family: var(--font-mono);
    }
    .annotation-card .del-btn {
      background: none; border: none; color: var(--text-dim); cursor: pointer;
      font-size: 10px; font-family: var(--font-mono);
      transition: color 0.15s;
    }
    .annotation-card .del-btn:hover { color: var(--red); }

    .sidebar-hint {
      padding: 28px 18px; color: var(--text-muted); font-size: 12.5px;
      text-align: center; line-height: 1.8;
    }

    .badge {
      background: var(--teal-dim); color: var(--teal);
      padding: 0 5px; border-radius: 4px; font-size: 10px;
      font-weight: 600; margin-left: 5px;
      font-family: var(--font-mono);
    }

    /* System panel */
    #system-panel { padding: 12px; }
    .sys-section { margin-bottom: 16px; }
    .sys-section-title {
      font-size: 10px; font-weight: 600; color: var(--teal);
      text-transform: uppercase; letter-spacing: 0.1em;
      margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border);
      font-family: var(--font-mono); opacity: 0.8;
    }
    .sys-item {
      font-size: 12px; color: var(--text-muted); padding: 3px 0;
      display: flex; justify-content: space-between; align-items: center;
    }
    .sys-item .name { color: var(--text); font-weight: 500; }
    .sys-item .val { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); }
    .sys-pill {
      display: inline-block; font-size: 10px; padding: 2px 6px;
      border-radius: 3px; margin: 2px 3px 2px 0; font-weight: 500;
      font-family: var(--font-mono);
    }
    .sys-pill.on { background: rgba(58,158,106,0.08); color: var(--green); }
    .sys-pill.off { background: rgba(158,58,58,0.06); color: var(--text-dim); text-decoration: line-through; }
    .sys-pill.hook { background: rgba(158,138,58,0.07); color: var(--yellow); }
    .sys-pill.mcp { background: rgba(58,158,143,0.07); color: var(--teal); }
    .animated-num {
      font-variant-numeric: tabular-nums;
      display: inline-block;
      min-width: 0;
    }
    .sys-stat {
      font-size: 18px; font-weight: 600; color: var(--text-bright);
      font-family: var(--font-mono); letter-spacing: -0.02em;
      font-variant-numeric: tabular-nums;
    }
    .sys-stat-label { font-size: 10px; color: var(--text-dim); margin-top: 2px; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.06em; }

    .sys-stats-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;
    }
    .sys-stat-card {
      background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: var(--r); padding: 10px; text-align: center;
    }

    /* === Annotation Popup === */
    #annotation-popup {
      display: none; position: fixed; background: var(--bg-elevated);
      border: 1px solid var(--teal); border-radius: var(--r-lg);
      padding: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); z-index: 1000; width: 300px;
      opacity: 0; transform: translateY(4px);
      transition: opacity 0.15s var(--ease), transform 0.15s var(--ease);
    }
    #annotation-popup.visible { display: block; opacity: 1; transform: translateY(0); }
    #popup-preview {
      font-size: 12px; color: var(--text-muted); border-left: 2px solid var(--teal);
      padding-left: 8px; margin-bottom: 10px; max-height: 48px; overflow: hidden;
      font-style: italic; line-height: 1.4;
    }
    #popup-comment {
      width: 100%; min-height: 52px; background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--r); color: var(--text); padding: 8px; font-size: 13px;
      font-family: var(--font-sans); resize: vertical; line-height: 1.5;
      transition: border-color 0.15s var(--ease);
    }
    #popup-comment:focus { outline: none; border-color: rgba(58,158,143,0.3); }
    .popup-actions { display: flex; gap: 6px; margin-top: 8px; justify-content: flex-end; }
    .btn {
      padding: 4px 10px; border-radius: var(--r); border: 1px solid var(--border);
      background: var(--bg-surface); color: var(--text-muted); font-size: 12px; cursor: pointer;
      font-family: var(--font-mono); font-weight: 500; transition: all 0.15s var(--ease);
      letter-spacing: 0.02em;
    }
    .btn:hover { background: var(--bg-elevated); color: var(--text); }
    .btn-primary { background: var(--teal-dim); border-color: rgba(58,158,143,0.2); color: var(--teal); }
    .btn-primary:hover { background: rgba(58,158,143,0.12); color: var(--teal-bright); }

    /* === Status Bar === */
    #status-bar {
      position: fixed; bottom: 0; left: 0; right: 280px;
      background: var(--bg-surface); border-top: 1px solid var(--border);
      padding: 3px 16px; font-size: 10px; color: var(--text-dim);
      display: flex; gap: 12px; align-items: center;
      font-family: var(--font-mono); font-weight: 500;
      letter-spacing: 0.03em;
    }
    .status-dot { width: 4px; height: 4px; border-radius: 50%; display: inline-block; }
    .status-dot.connected { background: var(--teal); opacity: 0.6; }
    .status-dot.disconnected { background: var(--red); opacity: 0.5; }

    /* === Empty State === */
    #empty-state {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 60vh; color: var(--text-dim);
    }
    #empty-state .brand {
      font-size: 14px; color: var(--text-dim); font-weight: 500;
      font-family: var(--font-mono); letter-spacing: 0.2em;
      margin-bottom: 8px; opacity: 0.5;
      animation: pulse 4s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }
    #empty-state .line {
      width: 32px; height: 1px; background: var(--border-bright);
      margin-bottom: 14px;
    }
    #empty-state p { font-size: 11px; line-height: 1.8; }

    /* Teal selection — user interaction color */
    ::selection { background: rgba(58, 158, 143, 0.18); }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.04); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.07); }
  </style>
</head>
<body>
<div id="app">
  <div id="tab-bar">
    <div id="tab-bar-brand">foldspace</div>
    <div id="tab-bar-tabs"></div>
  </div>

  <div id="main">
    <div id="content">
      <div class="session-header" id="session-header" style="display:none"></div>
      <div id="responses-area">
        <div id="responses"></div>
        <div id="empty-state">
          <div class="brand">foldspace</div>
          <div class="line"></div>
          <p>waiting for sessions</p>
          <p>select text to annotate</p>
        </div>
      </div>
    </div>

    <div id="sidebar">
      <div class="sidebar-tabs">
        <div class="sidebar-tab active" data-panel="annotations-panel" onclick="switchSidebarTab(this)">
          annotations<span class="badge" id="annotation-count">0</span>
        </div>
        <div class="sidebar-tab" data-panel="system-panel" onclick="switchSidebarTab(this)">
          system
        </div>
      </div>
      <div class="sidebar-panel active" id="annotations-panel">
        <div id="annotation-list">
          <div class="sidebar-hint">Select text in a response to annotate it.<br>Annotations inject as context on your next prompt.</div>
        </div>
      </div>
      <div class="sidebar-panel" id="system-panel">
        <div id="system-content">
          <div class="sidebar-hint">loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="annotation-popup">
  <div id="popup-preview"></div>
  <textarea id="popup-comment" placeholder="annotate..."></textarea>
  <div class="popup-actions">
    <button class="btn" id="popup-cancel">cancel</button>
    <button class="btn btn-primary" id="popup-submit">annotate</button>
  </div>
</div>

<div id="status-bar">
  <span><span class="status-dot disconnected" id="status-dot"></span></span>
  <span id="status-text">connecting</span>
  <span id="status-sessions">0 sessions</span>
</div>

<script>
  // === State ===
  let ws = null;
  const sessions = new Map();
  const responses = new Map();
  const allAnnotations = new Map();
  let activeSessionId = null;
  let pendingSelection = null;
  let autoScroll = true;
  let globalConfig = null;

  const PORT = window.location.port || 3377;
  const WS_URL = `ws://${window.location.hostname}:${PORT}/ws`;
  const API = `http://${window.location.hostname}:${PORT}`;

  marked.setOptions({
    highlight: (code, lang) => {
      if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value;
      return hljs.highlightAuto(code).value;
    },
    breaks: true, gfm: true,
  });

  const renderer = new marked.Renderer();
  renderer.code = function({ text, lang }) {
    const langLabel = lang || '';
    const highlighted = lang && hljs.getLanguage(lang)
      ? hljs.highlight(text, { language: lang }).value
      : hljs.highlightAuto(text).value;
    const escaped = text.replace(/"/g, '&quot;').replace(/</g, '&lt;');
    return `<pre><div class="code-header"><span class="code-lang">${esc(langLabel)}</span><button class="copy-btn" onclick="copyCode(this)" data-code="${escaped}">copy</button></div><code>${highlighted}</code></pre>`;
  };
  marked.setOptions({ renderer });

  // === WebSocket ===
  function connectWS() {
    ws = new WebSocket(WS_URL);
    ws.onopen = () => { $('status-dot').className = 'status-dot connected'; $('status-text').textContent = 'connected'; };
    ws.onclose = () => { $('status-dot').className = 'status-dot disconnected'; $('status-text').textContent = 'reconnecting'; setTimeout(connectWS, 2000); };
    ws.onerror = () => ws.close();
    ws.onmessage = (e) => {
      const m = JSON.parse(e.data);
      if (m.type === 'init') onInit(m.data);
      if (m.type === 'session_started') onSessionStarted(m.data);
      if (m.type === 'session_ended') onSessionEnded(m.data);
      if (m.type === 'new_response') onNewResponse(m.data);
      if (m.type === 'annotation_added') onAnnotationAdded(m.data);
      if (m.type === 'session_git_status') onSessionGitStatus(m.data);
      if (m.type === 'session_stats_update') onSessionStatsUpdate(m.data);
    };
  }

  function onInit(data) {
    sessions.clear(); responses.clear(); allAnnotations.clear();
    (data.sessions || []).forEach(s => sessions.set(s.sessionId, s));
    for (const [sid, r] of Object.entries(data.responses || {})) responses.set(sid, r);
    for (const [sid, a] of Object.entries(data.annotations || {})) allAnnotations.set(sid, a);
    renderTabs();
    if (sessions.size > 0 && !activeSessionId) {
      const latest = [...sessions.values()].sort((a,b) => b.lastActivity - a.lastActivity)[0];
      switchSession(latest.sessionId);
    }
    updateStatus();
    loadConfig();
  }

  function onSessionStarted(meta) {
    sessions.set(meta.sessionId, meta);
    if (!responses.has(meta.sessionId)) responses.set(meta.sessionId, []);
    if (!allAnnotations.has(meta.sessionId)) allAnnotations.set(meta.sessionId, []);
    renderTabs();
    switchSession(meta.sessionId);
    updateStatus();
  }

  function onSessionEnded(data) {
    const m = sessions.get(data.sessionId);
    if (m) m._ended = true;
    renderTabs();
  }

  function onNewResponse(resp) {
    const sid = resp.sessionId || 'unknown';
    if (!responses.has(sid)) responses.set(sid, []);
    responses.get(sid).push(resp);
    const m = sessions.get(sid);
    if (m) { m.lastActivity = Date.now(); m.turnCount = (m.turnCount || 0) + 1; }
    if (sid === activeSessionId) {
      renderResponse(resp, responses.get(sid).length);
      $('empty-state').style.display = 'none';
      renderSessionHeader();
      if (autoScroll) scrollBottom();
    }
    renderTabs(); updateStatus();
  }

  function onAnnotationAdded(ann) {
    const sid = ann.sessionId || 'unknown';
    if (!allAnnotations.has(sid)) allAnnotations.set(sid, []);
    allAnnotations.get(sid).push(ann);
    if (sid === activeSessionId) renderAnnotations();
  }

  function onSessionGitStatus(data) {
    const m = sessions.get(data.sessionId);
    if (m) {
      m.gitStatus = data.gitStatus;
      if (data.gitStatus && data.gitStatus.branch) {
        m.gitBranch = data.gitStatus.branch;
      }
    }
    if (data.sessionId === activeSessionId) renderSessionHeader();
  }

  function onSessionStatsUpdate(data) {
    const m = sessions.get(data.sessionId);
    if (!m) return;
    m.totalTokensIn = data.totalTokensIn;
    m.totalTokensOut = data.totalTokensOut;
    m.turnCount = data.turnCount;
    m.lastActivity = Date.now();
    if (data.sessionId === activeSessionId) renderSessionHeader();
  }

  // === Config ===
  async function loadConfig() {
    try {
      const resp = await fetch(`${API}/api/config`);
      globalConfig = await resp.json();
      renderSystem();
    } catch {}
  }

  function renderSystem() {
    const c = $('system-content');
    if (!globalConfig) { c.innerHTML = '<div class="sidebar-hint">unavailable</div>'; return; }

    const g = globalConfig;
    const plugins = Object.entries(g.settings?.enabledPlugins || {});
    const enabledPlugins = plugins.filter(([,v]) => v);
    const disabledPlugins = plugins.filter(([,v]) => !v);
    const hooks = Object.entries(g.settings?.hooks || {});
    const mcpServers = g.settings?.mcpServers || [];
    const skills = g.globalSkills || [];
    const stats = g.stats || {};
    const env = Object.entries(g.settings?.env || {});

    let html = '';

    if (stats.totalSessions) {
      html += `<div class="sys-section"><div class="sys-section-title">stats</div>
        <div class="sys-stats-grid">
          <div class="sys-stat-card"><div class="sys-stat animated-num" id="sys-total-sessions" data-raw-value="${stats.totalSessions}">${formatNum(stats.totalSessions)}</div><div class="sys-stat-label">sessions</div></div>
          <div class="sys-stat-card"><div class="sys-stat animated-num" id="sys-total-messages" data-raw-value="${stats.totalMessages}">${formatNum(stats.totalMessages)}</div><div class="sys-stat-label">messages</div></div>
        </div>
        ${stats.firstSessionDate ? `<div class="sys-item"><span class="name">first session</span><span class="val">${new Date(stats.firstSessionDate).toLocaleDateString()}</span></div>` : ''}
      </div>`;
    }

    if (g.claudeVersion) {
      html += `<div class="sys-section"><div class="sys-section-title">version</div>
        <div class="sys-item"><span class="name">claude code</span><span class="val">${esc(g.claudeVersion)}</span></div>
      </div>`;
    }

    if (plugins.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">plugins</div>`;
      const grouped = {};
      enabledPlugins.forEach(([name]) => {
        const parts = name.split('@');
        const market = parts[1] || 'local';
        if (!grouped[market]) grouped[market] = [];
        grouped[market].push(parts[0]);
      });
      for (const [market, names] of Object.entries(grouped)) {
        html += `<div style="margin-bottom:6px"><div style="font-size:9px;color:var(--text-dim);margin-bottom:3px;font-family:var(--font-mono);letter-spacing:0.05em">${esc(market)}</div>`;
        names.forEach(n => { html += `<span class="sys-pill on">${esc(n)}</span>`; });
        html += '</div>';
      }
      if (disabledPlugins.length > 0) {
        html += '<div style="margin-top:4px">';
        disabledPlugins.forEach(([name]) => {
          html += `<span class="sys-pill off">${esc(name.split('@')[0])}</span>`;
        });
        html += '</div>';
      }
      html += '</div>';
    }

    if (hooks.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">hooks</div>`;
      hooks.forEach(([event, count]) => {
        html += `<div class="sys-item"><span class="name">${esc(event)}</span><span class="val">${count}</span></div>`;
      });
      html += '</div>';
    }

    if (mcpServers.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">mcp</div>`;
      mcpServers.forEach(s => { html += `<span class="sys-pill mcp">${esc(s)}</span>`; });
      html += '</div>';
    }

    if (skills.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">skills</div>`;
      skills.forEach(s => { html += `<span class="sys-pill on">${esc(s)}</span>`; });
      html += '</div>';
    }

    if (env.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">env</div>`;
      env.forEach(([k, v]) => {
        html += `<div class="sys-item"><span class="name" style="font-family:var(--font-mono);font-size:10px">${esc(k)}</span><span class="val">${esc(String(v))}</span></div>`;
      });
      html += '</div>';
    }

    if (stats.modelUsage) {
      html += `<div class="sys-section"><div class="sys-section-title">token usage</div>`;
      for (const [model, usage] of Object.entries(stats.modelUsage)) {
        const u = usage;
        const total = (u.inputTokens || 0) + (u.outputTokens || 0) + (u.cacheReadInputTokens || 0);
        html += `<div class="sys-item"><span class="name" style="font-size:10px">${esc(model.replace('claude-', ''))}</span><span class="val">${formatTokens(total)}</span></div>`;
      }
      html += '</div>';
    }

    c.innerHTML = html;
  }

  // === Tabs ===
  const prevBadgeCounts = new Map(); // Track previous badge values for animation

  function renderTabs() {
    const bar = $('tab-bar-tabs');
    bar.innerHTML = '';
    const badgesToAnimate = [];
    [...sessions.values()].sort((a,b) => a.startedAt - b.startedAt).forEach(s => {
      const t = document.createElement('div');
      t.className = 'tab' + (s.sessionId === activeSessionId ? ' active' : '');
      const dot = s._ended ? 'tab-dot ended' : 'tab-dot';
      const label = sessionLabel(s);
      const rc = (responses.get(s.sessionId) || []).length;
      const badgeId = 'tab-badge-' + s.sessionId.slice(0,8);
      const badge = rc > 0 && s.sessionId !== activeSessionId
        ? `<span class="tab-badge animated-num" id="${badgeId}" data-raw-value="${rc}">${rc}</span>` : '';
      t.innerHTML = `<span class="${dot}"></span>${esc(label)}${badge}`;
      t.onclick = () => switchSession(s.sessionId);
      bar.appendChild(t);

      // Queue animation if badge is visible and value changed
      if (rc > 0 && s.sessionId !== activeSessionId) {
        const prev = prevBadgeCounts.get(s.sessionId) || 0;
        if (prev !== rc && prev > 0) {
          badgesToAnimate.push({ id: badgeId, oldVal: prev, newVal: rc });
        }
        prevBadgeCounts.set(s.sessionId, rc);
      }
    });

    // Animate badge counts after DOM is built
    badgesToAnimate.forEach(({ id, oldVal, newVal }) => {
      const el = $(id);
      if (el) animateValue(el, oldVal, newVal, 400, String);
    });
  }

  function sessionLabel(m) {
    if (m.gitRepo) return m.gitRepo.split('/').pop();
    if (m.cwd) { const p = m.cwd.split('/'); return p[p.length-1] || p[p.length-2] || 'session'; }
    return m.sessionId.slice(0,8);
  }

  function switchSession(sid) {
    activeSessionId = sid;
    headerSessionId = null; // Force full header rebuild on session switch
    renderTabs(); renderSessionHeader(); renderAllResponses(); renderAnnotations();
  }

  // === Session Header ===
  // Track which session the header was last built for
  let headerSessionId = null;

  function renderSessionHeader() {
    const h = $('session-header');
    const m = sessions.get(activeSessionId);
    if (!m) { h.style.display = 'none'; headerSessionId = null; return; }
    h.style.display = 'block';

    // If switching sessions or first render, rebuild the full header
    if (headerSessionId !== activeSessionId) {
      headerSessionId = activeSessionId;
      const model = (m.model||'unknown').replace('claude-','').replace(/-\d+$/,'');
      const started = new Date(m.startedAt).toLocaleTimeString();
      h.innerHTML = `
        <div class="sh-row1">
          <span class="sh-cwd">${esc(m.cwd||'')}</span>
          <span class="sh-pill model">${esc(model)}</span>
          <span class="sh-pill perm">${esc(m.permissionMode||'default')}</span>
          ${m.source && m.source !== 'startup' ? `<span class="sh-pill source">${esc(m.source)}</span>` : ''}
        </div>
        <div class="sh-grid">
          ${mi('branch', m.gitBranch||'-')}${mi('repo', m.gitRepo||'-')}${mi('started', started)}
          ${miAnim('turns', m.turnCount||0, 'sh-turns', formatNum)}${miAnim('in', m.totalTokensIn||0, 'sh-tok-in', formatTokens)}${miAnim('out', m.totalTokensOut||0, 'sh-tok-out', formatTokens)}
          ${m.claudeVersion ? mi('cc', m.claudeVersion) : ''}
        </div>
        ${renderGitStatus(m.gitStatus)}`;
      return;
    }

    // Same session — animate the changing numeric values
    updateAnimatedNum($('sh-turns'), m.turnCount || 0, formatNum);
    updateAnimatedNum($('sh-tok-in'), m.totalTokensIn || 0, formatTokens);
    updateAnimatedNum($('sh-tok-out'), m.totalTokensOut || 0, formatTokens);
    // Re-render git status (it changes independently of numeric stats)
    const gitContainer = h.querySelector('.sh-git');
    const newGit = renderGitStatus(m.gitStatus);
    if (newGit) {
      if (gitContainer) gitContainer.outerHTML = newGit;
      else h.insertAdjacentHTML('beforeend', newGit);
    } else if (gitContainer) {
      gitContainer.remove();
    }
  }

  function renderGitStatus(gs) {
    if (!gs) return '';
    const parts = [];

    const dotClass = gs.conflicted > 0 ? 'conflict' :
                     (gs.staged + gs.modified + gs.untracked > 0) ? 'dirty' : 'clean';
    parts.push(`<span class="sh-git-dot ${dotClass}"></span>`);
    parts.push(`<span class="sh-git-branch">${esc(gs.branch || '(detached)')}</span>`);

    const syncParts = [];
    if (gs.ahead > 0) syncParts.push(`<span class="ahead">&uarr;${gs.ahead}</span>`);
    if (gs.behind > 0) syncParts.push(`<span class="behind">&darr;${gs.behind}</span>`);
    if (syncParts.length > 0) {
      parts.push(`<span class="sh-git-sync">${syncParts.join(' ')}</span>`);
    }

    const fileParts = [];
    if (gs.staged > 0) fileParts.push(`<span class="gs gs-staged">+${gs.staged}</span>`);
    if (gs.modified > 0) fileParts.push(`<span class="gs gs-modified">~${gs.modified}</span>`);
    if (gs.untracked > 0) fileParts.push(`<span class="gs gs-untracked">?${gs.untracked}</span>`);
    if (gs.conflicted > 0) fileParts.push(`<span class="gs gs-conflicted">!${gs.conflicted}</span>`);
    if (fileParts.length > 0) {
      parts.push(`<span class="sh-git-files">${fileParts.join('')}</span>`);
    } else if (dotClass === 'clean') {
      parts.push(`<span class="sh-git-clean">clean</span>`);
    }

    return `<div class="sh-git">${parts.join('')}</div>`;
  }

  function mi(l,v) { return `<span class="mi"><span class="ml">${l}</span><span class="mv">${esc(String(v))}</span></span>`; }
  function miAnim(l, rawVal, id, formatter) {
    return `<span class="mi"><span class="ml">${l}</span><span class="mv animated-num" id="${id}" data-raw-value="${rawVal}">${formatter(rawVal)}</span></span>`;
  }

  // === Responses ===
  function renderAllResponses() {
    const c = $('responses'); c.innerHTML = '';
    const r = responses.get(activeSessionId) || [];
    if (!r.length) { $('empty-state').style.display = 'flex'; return; }
    $('empty-state').style.display = 'none';
    r.forEach((resp,i) => renderResponse(resp, i+1));
  }

  function renderResponse(resp, num) {
    const d = document.createElement('div');
    d.className = 'response-entry';
    d.dataset.responseId = resp.id;
    d.dataset.sessionId = resp.sessionId;
    const t = new Date(resp.timestamp).toLocaleTimeString();
    d.innerHTML = `<div class="response-meta"><span class="response-num">${num}</span><span>${t}</span></div><div class="md">${marked.parse(resp.content||'')}</div>`;
    $('responses').appendChild(d);
  }

  // === Annotations ===
  function renderAnnotations() {
    const list = $('annotation-list');
    const anns = allAnnotations.get(activeSessionId) || [];
    $('annotation-count').textContent = anns.length;
    if (!anns.length) {
      list.innerHTML = '<div class="sidebar-hint">Select text in a response to annotate it.<br>Annotations inject as context on your next prompt.</div>';
      return;
    }
    list.innerHTML = anns.map(a => `
      <div class="annotation-card" data-id="${a.id}">
        <div class="sel">${esc(a.selectedText)}</div>
        <div class="cmt">${esc(a.comment)}</div>
        <div class="meta"><span>${new Date(a.timestamp).toLocaleTimeString()}</span><button class="del-btn" onclick="delAnnotation('${a.id}')">remove</button></div>
      </div>`).join('');
  }

  async function delAnnotation(id) {
    await fetch(`${API}/api/annotations?action=delete`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id}) });
    for (const [,a] of allAnnotations) { const i = a.findIndex(x=>x.id===id); if (i!==-1) { a.splice(i,1); break; } }
    renderAnnotations();
  }

  // === Sidebar Tabs ===
  function switchSidebarTab(el) {
    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    $(el.dataset.panel).classList.add('active');
    // Lazy-load mise data when System tab is opened
    if (el.dataset.panel === 'system-panel') loadMise();
  }

  // === Annotation Popup ===
  document.addEventListener('mouseup', (e) => {
    const sel = window.getSelection(); const txt = sel.toString().trim();
    if (!txt || txt.length < 3) { hidePopup(); return; }
    const entry = e.target.closest('.response-entry');
    if (!entry) { hidePopup(); return; }
    pendingSelection = { text: txt, responseId: entry.dataset.responseId, sessionId: entry.dataset.sessionId || activeSessionId };
    const rect = sel.getRangeAt(0).getBoundingClientRect();
    const popup = $('annotation-popup');
    let left = rect.left, top = rect.bottom + 8;
    if (left + 300 > window.innerWidth - 280) left = window.innerWidth - 600;
    if (top + 160 > window.innerHeight) top = rect.top - 160;
    popup.style.left = Math.max(8, left) + 'px'; popup.style.top = top + 'px';
    $('popup-preview').textContent = txt.length > 80 ? txt.slice(0,80)+'...' : txt;
    popup.classList.add('visible'); $('popup-comment').focus();
  });

  $('popup-cancel').addEventListener('click', hidePopup);
  $('popup-submit').addEventListener('click', submitAnnotation);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { hidePopup(); closeConfigModal(); }
    if (e.key === 'Enter' && e.metaKey && $('annotation-popup').classList.contains('visible')) submitAnnotation();
  });
  // Close config modal on overlay click
  $('config-modal').addEventListener('click', (e) => {
    if (e.target === $('config-modal')) closeConfigModal();
  });

  async function submitAnnotation() {
    const comment = $('popup-comment').value.trim();
    if (!comment || !pendingSelection) return;
    await fetch(`${API}/api/annotate`, { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ sessionId: pendingSelection.sessionId, responseId: pendingSelection.responseId, selectedText: pendingSelection.text, comment })
    });
    hidePopup(); window.getSelection().removeAllRanges();
  }

  function hidePopup() { $('annotation-popup').classList.remove('visible'); $('popup-comment').value = ''; pendingSelection = null; }

  // === Copy Code ===
  function copyCode(btn) {
    const code = btn.dataset.code.replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
    navigator.clipboard.writeText(code).then(() => {
      btn.textContent = 'copied'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'copy'; btn.classList.remove('copied'); }, 1500);
    });
  }

  // === Animated Numbers ===
  // Ease-out cubic: decelerates into final value
  function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

  // Smoothly animate a numeric value between old and new
  // el: DOM element with class="animated-num" and data-raw-value
  // formatter: function(rawNumber) => display string (e.g. formatTokens)
  function animateValue(el, oldVal, newVal, duration, formatter) {
    if (oldVal === newVal) return;
    // Cancel any in-flight animation on this element
    if (el._animFrame) cancelAnimationFrame(el._animFrame);

    const startTime = performance.now();
    const delta = newVal - oldVal;

    function tick(now) {
      const elapsed = now - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = easeOutCubic(progress);
      const current = Math.round(oldVal + delta * eased);
      el.textContent = formatter(current);
      if (progress < 1) {
        el._animFrame = requestAnimationFrame(tick);
      } else {
        el.textContent = formatter(newVal);
        el._animFrame = null;
      }
    }
    el._animFrame = requestAnimationFrame(tick);
  }

  // Update an animated-num span: reads old data-raw-value, sets new, animates
  function updateAnimatedNum(el, newRaw, formatter, duration) {
    if (!el) return;
    duration = duration || 500;
    const oldRaw = parseInt(el.getAttribute('data-raw-value') || '0', 10) || 0;
    el.setAttribute('data-raw-value', String(newRaw));
    if (oldRaw === newRaw) return;
    animateValue(el, oldRaw, newRaw, duration, formatter);
  }

  // === Utils ===
  function $(id) { return document.getElementById(id); }
  function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
  function scrollBottom() { const a = $('responses-area'); a.scrollTop = a.scrollHeight; }
  function updateStatus() { $('status-sessions').textContent = `${sessions.size} session${sessions.size!==1?'s':''}`; }
  function formatTokens(n) { if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'K'; return String(n); }
  function formatNum(n) { if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'K'; return String(n); }

  $('responses-area').addEventListener('scroll', (e) => {
    const t = e.target; autoScroll = (t.scrollHeight - t.scrollTop - t.clientHeight) < 100;
  });

  connectWS();
</script>
</body>
</html>
