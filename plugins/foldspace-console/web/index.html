<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>foldspace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <style>
    :root {
      /*
       * Subterranean Precision
       * Deep blue-black backgrounds with cold undertone.
       * Amber: brand accent, used sparingly — one indicator light, not paint.
       * Teal: signal color — active states, user interactions, status.
       * Everything else: metallic gray-blue, barely-there borders.
       */
      --bg: #060810;
      --bg-surface: #0a0c14;
      --bg-elevated: #0f1219;
      --bg-hover: #13161f;
      --bg-inset: #04050a;
      --border: rgba(255,255,255,0.06);
      --border-bright: rgba(255,255,255,0.10);

      --text: #94a0b4;
      --text-bright: #cdd3de;
      --text-muted: #647080;
      --text-dim: #3a4558;

      /* Amber — brand, warmth, sparingly */
      --amber: #b88a3e;
      --amber-dim: rgba(184,138,62,0.08);
      --amber-bright: #d4a650;

      /* Teal — signal, interaction, status */
      --teal: #3a9e8f;
      --teal-dim: rgba(58,158,143,0.07);
      --teal-bright: #52b8a8;

      /* Signal */
      --green: #3a9e6a;
      --red: #9e3a3a;
      --yellow: #9e8a3a;

      --font-sans: 'Instrument Sans', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      --font-mono: 'IBM Plex Mono', 'SF Mono', monospace;
      --r: 4px;
      --r-lg: 6px;
      --ease: cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      font-size: 15px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Faint noise texture — looking through facility glass */
    body::after {
      content: '';
      position: fixed; inset: 0; z-index: 9999;
      pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      opacity: 0.012;
      mix-blend-mode: overlay;
    }

    #app { display: flex; height: 100vh; flex-direction: column; }

    /* === Tab Bar === */
    #tab-bar {
      display: flex;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      min-height: 36px;
      align-items: stretch;
      flex-shrink: 0;
    }
    #tab-bar-brand {
      display: flex; align-items: center; padding: 0 16px;
      border-right: 1px solid var(--border); flex-shrink: 0;
      color: var(--text-muted); font-size: 12px; font-weight: 500;
      font-family: var(--font-mono); letter-spacing: 0.12em;
      transition: color 0.3s var(--ease);
    }
    #tab-bar-brand:hover { color: var(--amber); }
    #tab-bar-tabs { display: flex; flex: 1; overflow: hidden; position: relative; }

    .tab {
      padding: 0 16px; font-size: 13px; font-weight: 500;
      color: var(--text-muted); border-bottom: 1px solid transparent;
      cursor: pointer; white-space: nowrap; display: flex;
      align-items: center; gap: 7px;
      transition: transform 180ms var(--ease), opacity 180ms var(--ease),
                  color 150ms var(--ease), background 150ms var(--ease),
                  border-color 150ms var(--ease);
      user-select: none; flex-shrink: 0;
    }
    .tab:hover { color: var(--text); background: var(--bg-hover); }
    .tab.active { color: var(--teal); border-bottom-color: var(--teal); }

    /* State: recent activity (< 5 min) */
    .tab.state-recent { color: var(--text-bright); }
    .tab.state-recent .tab-dot { background: var(--teal-bright); opacity: 1; }

    /* State: idle (5 min - 6 hrs) */
    .tab.state-idle .tab-dot { background: var(--teal); opacity: 0.4; }

    /* State: ended session */
    .tab.state-ended { color: var(--text-dim); font-style: italic; }
    .tab.state-ended .tab-dot { display: none; }

    .tab-dot {
      width: 5px; height: 5px; border-radius: 50%;
      background: var(--teal); flex-shrink: 0; opacity: 0.7;
      transition: background 180ms var(--ease), opacity 180ms var(--ease);
    }
    .tab-badge {
      font-size: 10px; background: var(--teal-dim); color: var(--teal);
      padding: 0 5px; border-radius: 4px; font-weight: 600;
      font-family: var(--font-mono); font-variant-numeric: tabular-nums;
    }

    /* Overflow button */
    .tab-overflow-btn {
      display: flex; align-items: center; padding: 0 12px;
      font-size: 12px; font-weight: 600; color: var(--text-dim);
      cursor: pointer; white-space: nowrap; flex-shrink: 0;
      font-family: var(--font-mono); letter-spacing: 0.02em;
      transition: color 150ms var(--ease), background 150ms var(--ease);
      user-select: none; border-left: 1px solid var(--border);
    }
    .tab-overflow-btn:hover { color: var(--text-muted); background: var(--bg-hover); }

    /* Overflow dropdown */
    .tab-overflow-dropdown {
      position: absolute; top: 100%; right: 0; z-index: 500;
      background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: 0 0 var(--r-lg) var(--r-lg);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      min-width: 240px; max-height: 320px; overflow-y: auto;
      display: none;
    }
    .tab-overflow-dropdown.visible { display: block; }
    .tab-overflow-item {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 14px; cursor: pointer; font-size: 12px;
      transition: background 120ms var(--ease);
    }
    .tab-overflow-item:hover { background: var(--bg-hover); }
    .tab-overflow-item .toi-label {
      flex: 1; color: var(--text-muted); font-weight: 500;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .tab-overflow-item .toi-time {
      font-size: 10px; color: var(--text-dim); font-family: var(--font-mono);
      flex-shrink: 0;
    }
    .tab-overflow-item .toi-dot {
      width: 4px; height: 4px; border-radius: 50%; flex-shrink: 0;
    }
    .tab-overflow-item.state-recent .toi-label { color: var(--text-bright); }
    .tab-overflow-item.state-recent .toi-dot { background: var(--teal-bright); }
    .tab-overflow-item.state-idle .toi-dot { background: var(--teal); opacity: 0.4; }
    .tab-overflow-item.state-ended .toi-label { color: var(--text-dim); font-style: italic; }
    .tab-overflow-item.state-ended .toi-dot { background: transparent; }

    /* === Main Layout === */
    #main { display: flex; flex: 1; overflow: hidden; }
    #content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* === Session Header === */
    .session-header {
      padding: 12px 36px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sh-row1 { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; flex-wrap: wrap; }
    .sh-cwd {
      font-size: 13px; font-weight: 500; color: var(--text-bright);
      font-family: var(--font-mono); letter-spacing: -0.01em;
    }
    .sh-pill {
      font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 3px;
      letter-spacing: 0.05em; text-transform: uppercase;
      font-family: var(--font-mono);
    }
    .sh-pill.model { background: var(--teal-dim); color: var(--teal); border: 1px solid rgba(58,158,143,0.1); }
    .sh-pill.perm { background: rgba(255,255,255,0.02); color: var(--text-dim); border: 1px solid var(--border); }
    .sh-pill.source { background: rgba(255,255,255,0.02); color: var(--text-muted); border: 1px solid var(--border); }
    .sh-grid {
      display: flex; flex-wrap: wrap; gap: 3px 16px; font-size: 12px;
    }
    .sh-grid .mi { display: flex; gap: 4px; align-items: baseline; }
    .sh-grid .ml { color: var(--text-dim); font-weight: 500; font-size: 11px; }
    .sh-grid .mv { color: var(--text-muted); font-family: var(--font-mono); font-size: 11px; font-variant-numeric: tabular-nums; }

    /* Git status row */
    .sh-git {
      display: flex; align-items: center; gap: 10px; margin-top: 5px;
      font-family: var(--font-mono); font-size: 11px; font-weight: 500;
      letter-spacing: 0.01em;
    }
    .sh-git-branch {
      color: var(--teal); overflow: hidden; text-overflow: ellipsis;
      white-space: nowrap; max-width: 200px;
    }
    .sh-git-sync { color: var(--text-muted); }
    .sh-git-sync .ahead { color: var(--teal); }
    .sh-git-sync .behind { color: var(--amber); }
    .sh-git-files { display: flex; gap: 8px; }
    .sh-git-files .gs { letter-spacing: 0; }
    .sh-git-files .gs-staged { color: var(--teal); }
    .sh-git-files .gs-modified { color: var(--amber); }
    .sh-git-files .gs-untracked { color: var(--text-muted); }
    .sh-git-files .gs-conflicted { color: var(--red); }
    .sh-git-clean { color: var(--teal); opacity: 0.5; font-size: 10px; }
    .sh-git-dot {
      width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0;
    }
    .sh-git-dot.clean { background: var(--teal); opacity: 0.5; }
    .sh-git-dot.dirty { background: var(--amber); opacity: 0.7; }
    .sh-git-dot.conflict { background: var(--red); opacity: 0.7; }

    /* === Response Stream === */
    #responses-area { flex: 1; overflow-y: auto; padding: 24px 36px 80px; }

    .response-entry {
      margin-bottom: 28px;
      animation: fadeIn 0.2s var(--ease);
    }
    .response-entry:not(:last-child) {
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .response-meta {
      font-size: 11px; color: var(--text-dim); margin-bottom: 14px;
      display: flex; gap: 8px; align-items: center;
      font-family: var(--font-mono); font-weight: 500; letter-spacing: 0.02em;
    }
    .response-num {
      color: var(--teal); opacity: 0.6;
    }

    /* === Markdown === */
    .md {
      font-size: 15px; line-height: 1.75; color: var(--text);
      max-width: 720px; word-wrap: break-word;
    }
    .md h1 {
      font-size: 1.4em; font-weight: 700; color: var(--text-bright);
      margin: 28px 0 12px; padding-bottom: 6px;
      border-bottom: 1px solid var(--border); letter-spacing: -0.02em;
    }
    .md h2 {
      font-size: 1.2em; font-weight: 600; color: var(--text-bright);
      margin: 24px 0 10px; padding-bottom: 4px;
      border-bottom: 1px solid var(--border);
    }
    .md h3 { font-size: 1.05em; font-weight: 600; color: var(--text-bright); margin: 18px 0 8px; }
    .md h4 { font-size: 1em; font-weight: 600; color: var(--text); margin: 14px 0 6px; }
    .md p { margin: 9px 0; }
    .md strong { color: var(--text-bright); font-weight: 600; }
    .md em { color: var(--text-muted); font-style: italic; }
    .md a { color: var(--teal); text-decoration: none; border-bottom: 1px solid transparent; transition: border-color 0.15s; }
    .md a:hover { border-bottom-color: var(--teal); }
    .md hr { border: none; border-top: 1px solid var(--border); margin: 22px 0; }

    .md code {
      background: var(--bg-elevated); padding: 1px 5px; border-radius: 3px;
      font-size: 0.87em; font-family: var(--font-mono); color: var(--text-bright);
      font-weight: 500; border: 1px solid var(--border);
    }

    .md pre {
      background: var(--bg-inset); border: 1px solid var(--border);
      border-radius: var(--r-lg); margin: 14px 0; position: relative;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .md pre code {
      display: block; padding: 14px 16px; overflow-x: auto;
      background: none; color: var(--text); font-size: 13.5px;
      line-height: 1.65; font-weight: 400; border: none;
    }
    .code-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 12px; background: rgba(255,255,255,0.015);
      border-bottom: 1px solid var(--border); font-size: 10px;
    }
    .code-lang { color: var(--text-muted); font-family: var(--font-mono); font-weight: 500; text-transform: lowercase; }
    .copy-btn {
      background: none; border: 1px solid var(--border); border-radius: 3px;
      color: var(--text-muted); font-size: 10px; padding: 2px 8px; cursor: pointer;
      font-family: var(--font-mono); font-weight: 500; transition: all 0.15s var(--ease);
      text-transform: lowercase; letter-spacing: 0.03em;
    }
    .copy-btn:hover { color: var(--text-muted); border-color: var(--border-bright); }
    .copy-btn.copied { color: var(--teal); border-color: rgba(58,158,143,0.3); }

    .md blockquote {
      border-left: 2px solid var(--border-bright); padding: 6px 14px; margin: 12px 0;
      color: var(--text-muted); font-size: 14.5px;
    }
    .md ul, .md ol { padding-left: 20px; margin: 8px 0; }
    .md li { margin: 4px 0; }
    .md li::marker { color: var(--text-dim); }

    .md table { border-collapse: collapse; margin: 14px 0; width: 100%; font-size: 13px; }
    .md th, .md td { border: 1px solid var(--border); padding: 7px 11px; text-align: left; }
    .md th { background: var(--bg-elevated); font-weight: 600; color: var(--text-bright); font-size: 11px; text-transform: uppercase; letter-spacing: 0.03em; }

    /* === Sidebar === */
    #sidebar {
      width: 280px; background: var(--bg-surface); border-left: 1px solid var(--border);
      display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden;
    }
    .sidebar-tabs {
      display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0;
    }
    .sidebar-tab {
      flex: 1; padding: 10px; font-size: 11px; font-weight: 600;
      color: var(--text-muted); text-align: center; cursor: pointer;
      text-transform: uppercase; letter-spacing: 0.08em;
      border-bottom: 1px solid transparent; transition: all 0.15s var(--ease);
      user-select: none; font-family: var(--font-mono);
    }
    .sidebar-tab:hover { color: var(--text-muted); }
    .sidebar-tab.active { color: var(--teal); border-bottom-color: var(--teal); }

    .sidebar-panel { flex: 1; overflow-y: auto; display: none; }
    .sidebar-panel.active { display: flex; flex-direction: column; }

    /* Annotations */
    #annotation-list { flex: 1; overflow-y: auto; padding: 8px; }
    .annotation-card {
      background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: var(--r); padding: 10px; margin-bottom: 5px;
      transition: border-color 0.15s var(--ease);
    }
    .annotation-card:hover { border-color: var(--border-bright); }
    .annotation-card .sel {
      font-size: 12.5px; color: var(--text-muted); border-left: 2px solid var(--teal);
      padding-left: 8px; margin-bottom: 6px; font-style: italic;
      max-height: 40px; overflow: hidden; line-height: 1.4;
      opacity: 0.8;
    }
    .annotation-card .cmt { font-size: 13px; color: var(--text); line-height: 1.5; }
    .annotation-card .meta {
      font-size: 10px; color: var(--text-dim); margin-top: 5px;
      display: flex; justify-content: space-between;
      font-family: var(--font-mono);
    }
    .annotation-card .del-btn {
      background: none; border: none; color: var(--text-dim); cursor: pointer;
      font-size: 10px; font-family: var(--font-mono);
      transition: color 0.15s;
    }
    .annotation-card .del-btn:hover { color: var(--red); }

    .sidebar-hint {
      padding: 28px 18px; color: var(--text-muted); font-size: 12.5px;
      text-align: center; line-height: 1.8;
    }

    .badge {
      background: var(--teal-dim); color: var(--teal);
      padding: 0 5px; border-radius: 4px; font-size: 10px;
      font-weight: 600; margin-left: 5px;
      font-family: var(--font-mono);
    }

    /* System panel */
    #system-panel { padding: 12px; }
    .sys-section { margin-bottom: 16px; }
    .sys-section-title {
      font-size: 10px; font-weight: 600; color: var(--teal);
      text-transform: uppercase; letter-spacing: 0.1em;
      margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border);
      font-family: var(--font-mono); opacity: 0.8;
    }
    .sys-item {
      font-size: 12px; color: var(--text-muted); padding: 3px 0;
      display: flex; justify-content: space-between; align-items: center;
    }
    .sys-item .name { color: var(--text); font-weight: 500; }
    .sys-item .val { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); }
    .sys-pill {
      display: inline-block; font-size: 10px; padding: 2px 6px;
      border-radius: 3px; margin: 2px 3px 2px 0; font-weight: 500;
      font-family: var(--font-mono);
    }
    .sys-pill.on { background: rgba(58,158,106,0.08); color: var(--green); }
    .sys-pill.off { background: rgba(158,58,58,0.06); color: var(--text-dim); text-decoration: line-through; }
    .sys-pill.hook { background: rgba(158,138,58,0.07); color: var(--yellow); }
    .sys-pill.mcp { background: rgba(58,158,143,0.07); color: var(--teal); }
    .animated-num {
      font-variant-numeric: tabular-nums;
      display: inline-block;
      min-width: 0;
    }
    .sys-stat {
      font-size: 18px; font-weight: 600; color: var(--text-bright);
      font-family: var(--font-mono); letter-spacing: -0.02em;
      font-variant-numeric: tabular-nums;
    }
    .sys-stat-label { font-size: 10px; color: var(--text-dim); margin-top: 2px; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 0.06em; }

    .sys-stats-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;
    }
    .sys-stat-card {
      background: var(--bg-elevated); border: 1px solid var(--border);
      border-radius: var(--r); padding: 10px; text-align: center;
    }

    /* === Annotation Popup === */
    #annotation-popup {
      display: none; position: fixed; background: var(--bg-elevated);
      border: 1px solid var(--teal); border-radius: var(--r-lg);
      padding: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); z-index: 1000; width: 300px;
      opacity: 0; transform: translateY(4px);
      transition: opacity 0.15s var(--ease), transform 0.15s var(--ease);
    }
    #annotation-popup.visible { display: block; opacity: 1; transform: translateY(0); }
    #popup-preview {
      font-size: 12px; color: var(--text-muted); border-left: 2px solid var(--teal);
      padding-left: 8px; margin-bottom: 10px; max-height: 48px; overflow: hidden;
      font-style: italic; line-height: 1.4;
    }
    #popup-comment {
      width: 100%; min-height: 52px; background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--r); color: var(--text); padding: 8px; font-size: 13px;
      font-family: var(--font-sans); resize: vertical; line-height: 1.5;
      transition: border-color 0.15s var(--ease);
    }
    #popup-comment:focus { outline: none; border-color: rgba(58,158,143,0.3); }
    .popup-actions { display: flex; gap: 6px; margin-top: 8px; justify-content: flex-end; }
    .btn {
      padding: 4px 10px; border-radius: var(--r); border: 1px solid var(--border);
      background: var(--bg-surface); color: var(--text-muted); font-size: 12px; cursor: pointer;
      font-family: var(--font-mono); font-weight: 500; transition: all 0.15s var(--ease);
      letter-spacing: 0.02em;
    }
    .btn:hover { background: var(--bg-elevated); color: var(--text); }
    .btn-primary { background: var(--teal-dim); border-color: rgba(58,158,143,0.2); color: var(--teal); }
    .btn-primary:hover { background: rgba(58,158,143,0.12); color: var(--teal-bright); }

    /* === Status Bar === */
    #status-bar {
      position: fixed; bottom: 0; left: 0; right: 280px;
      background: var(--bg-surface); border-top: 1px solid var(--border);
      padding: 3px 16px; font-size: 10px; color: var(--text-dim);
      display: flex; gap: 12px; align-items: center;
      font-family: var(--font-mono); font-weight: 500;
      letter-spacing: 0.03em;
    }
    .status-dot { width: 4px; height: 4px; border-radius: 50%; display: inline-block; }
    .status-dot.connected { background: var(--teal); opacity: 0.6; }
    .status-dot.disconnected { background: var(--red); opacity: 0.5; }

    /* === Empty State === */
    #empty-state {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 60vh; color: var(--text-dim);
    }
    #empty-state .brand {
      font-size: 14px; color: var(--text-dim); font-weight: 500;
      font-family: var(--font-mono); letter-spacing: 0.2em;
      margin-bottom: 8px; opacity: 0.5;
      animation: pulse 4s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.6; }
    }
    #empty-state .line {
      width: 32px; height: 1px; background: var(--border-bright);
      margin-bottom: 14px;
    }
    #empty-state p { font-size: 11px; line-height: 1.8; }

    /* === TOML Config Modal === */
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 2000;
      background: rgba(0,0,0,0.65);
      justify-content: center; align-items: center;
      opacity: 0; transition: opacity 0.2s var(--ease);
    }
    .modal-overlay.visible { display: flex; opacity: 1; }
    .modal-panel {
      background: var(--bg-elevated); border: 1px solid var(--border-bright);
      border-radius: var(--r-lg); max-width: 600px; width: 90%;
      max-height: 70vh; display: flex; flex-direction: column;
      box-shadow: 0 16px 64px rgba(0,0,0,0.5);
      transform: scale(0.96); opacity: 0;
      transition: transform 0.2s var(--ease), opacity 0.2s var(--ease);
    }
    .modal-overlay.visible .modal-panel { transform: scale(1); opacity: 1; }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .modal-title {
      font-size: 12px; font-weight: 600; color: var(--text-bright);
      font-family: var(--font-mono); letter-spacing: 0.03em;
    }
    .modal-close {
      background: none; border: 1px solid var(--border); border-radius: 3px;
      color: var(--text-muted); font-size: 10px; padding: 2px 8px; cursor: pointer;
      font-family: var(--font-mono); transition: all 0.15s var(--ease);
    }
    .modal-close:hover { color: var(--text); border-color: var(--border-bright); }
    .modal-body {
      flex: 1; overflow-y: auto; padding: 14px 16px;
    }
    .modal-body pre {
      background: var(--bg-inset); border: 1px solid var(--border);
      border-radius: var(--r); padding: 12px 14px; margin: 0;
      overflow-x: auto;
    }
    .modal-body pre code {
      font-size: 12px; font-family: var(--font-mono); color: var(--text);
      line-height: 1.6; white-space: pre;
    }

    /* Mise-specific styles */
    .mise-masked {
      color: var(--text-dim); font-family: var(--font-mono); font-size: 11px;
      letter-spacing: 0.02em;
    }
    .mise-config-link {
      background: none; border: 1px solid var(--border); border-radius: 3px;
      color: var(--teal); font-size: 10px; padding: 2px 8px; cursor: pointer;
      font-family: var(--font-mono); font-weight: 500;
      transition: all 0.15s var(--ease); display: inline-block;
      margin: 2px 3px 2px 0;
    }
    .mise-config-link:hover { border-color: var(--teal); background: var(--teal-dim); }
    .mise-toggle {
      background: none; border: none; color: var(--teal); cursor: pointer;
      font-size: 10px; font-family: var(--font-mono); font-weight: 500;
      padding: 4px 0; opacity: 0.7; transition: opacity 0.15s;
    }
    .mise-toggle:hover { opacity: 1; }

    /* === System Introspection Accordion === */
    .sys-accordion {
      margin-bottom: 2px;
    }
    .sys-acc-trigger {
      display: flex; align-items: center; gap: 6px;
      padding: 6px 8px; width: 100%;
      background: none; border: none; border-radius: var(--r);
      color: var(--text); font-size: 12px; font-weight: 500;
      font-family: var(--font-sans); cursor: pointer;
      transition: background 150ms var(--ease), color 150ms var(--ease);
      text-align: left; line-height: 1.4;
    }
    .sys-acc-trigger:hover { background: var(--bg-hover); }
    .sys-acc-trigger:focus-visible {
      outline: 1px solid var(--teal); outline-offset: -1px;
    }
    .sys-acc-chevron {
      width: 12px; height: 12px; flex-shrink: 0;
      color: var(--text-dim); transition: transform 150ms var(--ease);
      display: flex; align-items: center; justify-content: center;
      font-size: 9px; font-family: var(--font-mono);
    }
    .sys-acc-trigger[aria-expanded="true"] .sys-acc-chevron {
      transform: rotate(90deg);
    }
    .sys-acc-label { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .sys-acc-meta {
      font-size: 10px; color: var(--text-dim); font-family: var(--font-mono);
      flex-shrink: 0;
    }
    .sys-acc-dot {
      width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0;
    }
    .sys-acc-dot.active { background: var(--green); opacity: 0.8; }
    .sys-acc-dot.inactive { background: var(--text-dim); opacity: 0.4; }
    .sys-acc-dot.enabled { background: var(--teal); opacity: 0.7; }
    .sys-acc-dot.disabled { background: var(--text-dim); opacity: 0.3; }
    .sys-acc-dot.connected { background: var(--teal); opacity: 0.7; }

    .sys-acc-body {
      max-height: 0; overflow: hidden;
      transition: max-height 150ms var(--ease);
    }
    .sys-acc-body.expanded {
      max-height: 600px;
    }
    .sys-acc-content {
      padding: 4px 8px 10px 26px;
      font-size: 11px; color: var(--text-muted);
      font-family: var(--font-mono); line-height: 1.7;
    }
    .sys-acc-content .detail-row {
      display: flex; gap: 6px; align-items: baseline;
    }
    .sys-acc-content .detail-label {
      color: var(--text-dim); font-weight: 500; flex-shrink: 0;
      min-width: 60px;
    }
    .sys-acc-content .detail-value {
      color: var(--text-muted); word-break: break-all;
    }
    .sys-acc-content .detail-value.path {
      color: var(--text-dim); font-size: 10px;
    }
    .sys-acc-content .detail-pills {
      display: flex; flex-wrap: wrap; gap: 3px; margin-top: 2px;
    }
    .sys-acc-content .mini-pill {
      font-size: 9px; padding: 1px 5px; border-radius: 3px;
      font-weight: 500; font-family: var(--font-mono);
      background: rgba(58,158,143,0.06); color: var(--teal);
    }
    .sys-acc-content .mini-pill.hook {
      background: rgba(158,138,58,0.06); color: var(--yellow);
    }
    .sys-acc-content .mini-pill.source-global {
      background: rgba(255,255,255,0.03); color: var(--text-dim);
    }
    .sys-acc-content .mini-pill.source-plugin {
      background: rgba(58,158,143,0.04); color: var(--teal); opacity: 0.7;
    }

    /* Hook event group headers */
    .sys-hook-group {
      font-size: 10px; font-weight: 600; color: var(--text-dim);
      font-family: var(--font-mono); letter-spacing: 0.04em;
      padding: 6px 8px 2px; margin-top: 4px;
    }

    /* Teal selection — user interaction color */
    ::selection { background: rgba(58, 158, 143, 0.18); }
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.04); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.07); }

    /* === Sidecar Components === */
    .sidecar {
      background: var(--bg-inset); border: 1px solid var(--border);
      border-radius: var(--r-lg); margin: 14px 0; position: relative;
      overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    .sidecar-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 12px; background: rgba(255,255,255,0.015);
      border-bottom: 1px solid var(--border); font-size: 10px;
    }
    .sidecar-label {
      color: var(--teal); font-family: var(--font-mono); font-weight: 600;
      text-transform: lowercase; letter-spacing: 0.05em;
    }
    .sidecar-body { padding: 14px 16px; overflow-x: auto; }

    /* sidecar-mermaid */
    .sidecar-mermaid .sidecar-body {
      display: flex; justify-content: center; align-items: center;
      padding: 20px 16px; min-height: 80px;
    }
    .sidecar-mermaid .sidecar-body svg {
      max-width: 100%; height: auto;
    }

    /* sidecar-table */
    .sidecar-table .sc-table-filter {
      padding: 8px 12px; border-bottom: 1px solid var(--border);
    }
    .sidecar-table .sc-table-filter input {
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--r); color: var(--text); padding: 5px 10px;
      font-size: 12px; font-family: var(--font-mono);
      transition: border-color 0.15s var(--ease);
    }
    .sidecar-table .sc-table-filter input:focus {
      outline: none; border-color: rgba(58,158,143,0.3);
    }
    .sidecar-table .sc-table-filter input::placeholder {
      color: var(--text-dim);
    }
    .sidecar-table table {
      border-collapse: collapse; width: 100%; font-size: 12px;
      font-family: var(--font-mono);
    }
    .sidecar-table th {
      background: var(--bg-elevated); font-weight: 600; color: var(--text-bright);
      font-size: 10px; text-transform: uppercase; letter-spacing: 0.04em;
      padding: 7px 11px; text-align: left; border: 1px solid var(--border);
      cursor: pointer; user-select: none; white-space: nowrap;
      transition: background 0.15s var(--ease);
    }
    .sidecar-table th:hover { background: var(--bg-hover); }
    .sidecar-table th .sort-arrow {
      display: inline-block; margin-left: 4px; color: var(--teal); opacity: 0;
      transition: opacity 0.15s var(--ease);
    }
    .sidecar-table th.sorted .sort-arrow { opacity: 1; }
    .sidecar-table td {
      padding: 6px 11px; border: 1px solid var(--border); color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px;
    }
    .sidecar-table tr:hover td { background: var(--bg-hover); }
    .sidecar-table .sc-table-info {
      padding: 6px 12px; font-size: 10px; color: var(--text-dim);
      font-family: var(--font-mono); border-top: 1px solid var(--border);
    }

    /* sidecar-diff */
    .sidecar-diff .sidecar-body { padding: 0; }
    .sidecar-diff .diff-line {
      display: flex; font-family: var(--font-mono); font-size: 12.5px;
      line-height: 1.7; border-bottom: 1px solid rgba(255,255,255,0.02);
    }
    .sidecar-diff .diff-line:last-child { border-bottom: none; }
    .sidecar-diff .diff-gutter {
      width: 42px; flex-shrink: 0; text-align: right; padding: 0 8px 0 0;
      color: var(--text-dim); font-size: 11px; user-select: none;
      border-right: 1px solid var(--border);
    }
    .sidecar-diff .diff-content {
      flex: 1; padding: 0 12px; white-space: pre; overflow-x: auto;
    }
    .sidecar-diff .diff-add {
      background: rgba(58,158,106,0.08);
    }
    .sidecar-diff .diff-add .diff-content { color: var(--green); }
    .sidecar-diff .diff-add .diff-gutter { color: var(--green); opacity: 0.6; }
    .sidecar-diff .diff-del {
      background: rgba(158,58,58,0.08);
    }
    .sidecar-diff .diff-del .diff-content { color: var(--red); }
    .sidecar-diff .diff-del .diff-gutter { color: var(--red); opacity: 0.6; }
    .sidecar-diff .diff-hunk {
      background: rgba(58,158,143,0.04);
    }
    .sidecar-diff .diff-hunk .diff-content {
      color: var(--teal); font-style: italic; opacity: 0.7;
    }
    .sidecar-diff .diff-ctx .diff-content { color: var(--text-muted); }

    /* sidecar-json */
    .sidecar-json .sidecar-body {
      font-family: var(--font-mono); font-size: 12.5px; line-height: 1.7;
    }
    .sidecar-json .jt-row { white-space: nowrap; }
    .sidecar-json .jt-toggle {
      display: inline-block; width: 14px; text-align: center;
      cursor: pointer; color: var(--teal); user-select: none;
      font-size: 10px; transition: transform 0.15s var(--ease);
    }
    .sidecar-json .jt-toggle.collapsed { transform: rotate(-90deg); }
    .sidecar-json .jt-key { color: var(--text-bright); }
    .sidecar-json .jt-str { color: var(--green); }
    .sidecar-json .jt-num { color: var(--amber); }
    .sidecar-json .jt-bool { color: var(--teal); }
    .sidecar-json .jt-null { color: var(--text-dim); font-style: italic; }
    .sidecar-json .jt-bracket { color: var(--text-muted); }
    .sidecar-json .jt-children { padding-left: 18px; }
    .sidecar-json .jt-children.hidden { display: none; }
    .sidecar-json .jt-summary {
      color: var(--text-dim); font-style: italic; font-size: 11px; display: none;
    }
    .sidecar-json .jt-toggle.collapsed ~ .jt-summary { display: inline; }

    /* sidecar-progress */
    .sidecar-progress .sidecar-body {
      display: flex; align-items: center; gap: 14px; padding: 12px 16px;
    }
    .sidecar-progress .sp-status-dot {
      width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
    }
    .sidecar-progress .sp-status-dot.running {
      background: var(--teal); box-shadow: 0 0 6px rgba(58,158,143,0.4);
      animation: sp-pulse 1.5s ease-in-out infinite;
    }
    .sidecar-progress .sp-status-dot.done {
      background: var(--green);
    }
    .sidecar-progress .sp-status-dot.error {
      background: var(--red);
    }
    .sidecar-progress .sp-status-dot.pending {
      background: var(--text-dim);
    }
    @keyframes sp-pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .sidecar-progress .sp-info { flex: 1; min-width: 0; }
    .sidecar-progress .sp-label {
      font-size: 13px; color: var(--text-bright); font-weight: 500;
      margin-bottom: 4px; white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis;
    }
    .sidecar-progress .sp-bar-track {
      height: 4px; background: var(--bg-elevated); border-radius: 2px;
      overflow: hidden;
    }
    .sidecar-progress .sp-bar-fill {
      height: 100%; border-radius: 2px;
      transition: width 0.3s var(--ease);
    }
    .sidecar-progress .sp-bar-fill.running { background: var(--teal); }
    .sidecar-progress .sp-bar-fill.done { background: var(--green); }
    .sidecar-progress .sp-bar-fill.error { background: var(--red); }
    .sidecar-progress .sp-bar-fill.pending { background: var(--text-dim); }
    .sidecar-progress .sp-percent {
      font-size: 12px; font-family: var(--font-mono); font-weight: 600;
      color: var(--text-muted); flex-shrink: 0; min-width: 36px; text-align: right;
    }
  </style>
</head>
<body>
<div id="app">
  <div id="tab-bar">
    <div id="tab-bar-brand">foldspace</div>
    <div id="tab-bar-tabs"></div>
  </div>

  <div id="main">
    <div id="content">
      <div class="session-header" id="session-header" style="display:none"></div>
      <div id="responses-area">
        <div id="responses"></div>
        <div id="empty-state">
          <div class="brand">foldspace</div>
          <div class="line"></div>
          <p>waiting for sessions</p>
          <p>select text to annotate</p>
        </div>
      </div>
    </div>

    <div id="sidebar">
      <div class="sidebar-tabs">
        <div class="sidebar-tab active" data-panel="annotations-panel" onclick="switchSidebarTab(this)">
          annotations<span class="badge" id="annotation-count">0</span>
        </div>
        <div class="sidebar-tab" data-panel="system-panel" onclick="switchSidebarTab(this)">
          system
        </div>
      </div>
      <div class="sidebar-panel active" id="annotations-panel">
        <div id="annotation-list">
          <div class="sidebar-hint">Select text in a response to annotate it.<br>Annotations inject as context on your next prompt.</div>
        </div>
      </div>
      <div class="sidebar-panel" id="system-panel">
        <div id="system-content">
          <div class="sidebar-hint">loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="annotation-popup">
  <div id="popup-preview"></div>
  <textarea id="popup-comment" placeholder="annotate..."></textarea>
  <div class="popup-actions">
    <button class="btn" id="popup-cancel">cancel</button>
    <button class="btn btn-primary" id="popup-submit">annotate</button>
  </div>
</div>

<div class="modal-overlay" id="config-modal">
  <div class="modal-panel">
    <div class="modal-header">
      <span class="modal-title" id="config-modal-title"></span>
      <button class="modal-close" onclick="closeConfigModal()">close</button>
    </div>
    <div class="modal-body" id="config-modal-body"></div>
  </div>
</div>

<div id="status-bar">
  <span><span class="status-dot disconnected" id="status-dot"></span></span>
  <span id="status-text">connecting</span>
  <span id="status-sessions">0 sessions</span>
</div>

<script>
  // === State ===
  let ws = null;
  const sessions = new Map();
  const responses = new Map();
  const allAnnotations = new Map();
  let activeSessionId = null;
  let pendingSelection = null;
  let autoScroll = true;
  let globalConfig = null;
  let miseData = null;
  let miseLoaded = false;

  const PORT = window.location.port || 3377;
  const WS_URL = `ws://${window.location.hostname}:${PORT}/ws`;
  const API = `http://${window.location.hostname}:${PORT}`;

  marked.setOptions({
    highlight: (code, lang) => {
      if (lang && hljs.getLanguage(lang)) return hljs.highlight(code, { language: lang }).value;
      return hljs.highlightAuto(code).value;
    },
    breaks: true, gfm: true,
  });

  // Initialize mermaid with dark theme matching Ixian palette
  mermaid.initialize({
    startOnLoad: false,
    theme: 'dark',
    themeVariables: {
      darkMode: true,
      background: '#04050a',
      primaryColor: '#0f1219',
      primaryTextColor: '#cdd3de',
      primaryBorderColor: 'rgba(255,255,255,0.10)',
      lineColor: '#3a9e8f',
      secondaryColor: '#0a0c14',
      tertiaryColor: '#0f1219',
      fontFamily: "'IBM Plex Mono', 'SF Mono', monospace",
      fontSize: '13px',
    },
  });
  let mermaidIdCounter = 0;

  // === Sidecar Component Renderers ===

  function sidecarWrap(type, rawText, bodyHtml) {
    const escaped = rawText.replace(/"/g, '&quot;').replace(/</g, '&lt;');
    const label = type.replace('sidecar-', '');
    return `<div class="sidecar sidecar-${esc(label)}"><div class="sidecar-header"><span class="sidecar-label">${esc(label)}</span><button class="copy-btn" onclick="copyCode(this)" data-code="${escaped}">copy</button></div>${bodyHtml}</div>`;
  }

  function renderSidecarMermaid(text) {
    const id = 'mermaid-' + (++mermaidIdCounter);
    // Render async after DOM insertion; placeholder gets replaced via MutationObserver
    setTimeout(() => {
      const el = document.getElementById(id);
      if (!el) return;
      mermaid.render(id + '-svg', text).then(({ svg }) => {
        el.innerHTML = svg;
      }).catch(() => {
        el.innerHTML = '<span style="color:var(--red);font-size:12px;font-family:var(--font-mono)">mermaid render error</span>';
      });
    }, 0);
    return sidecarWrap('sidecar-mermaid', text,
      `<div class="sidecar-body" id="${id}"><span style="color:var(--text-dim);font-size:12px;font-family:var(--font-mono)">rendering diagram...</span></div>`
    );
  }

  function renderSidecarTable(text) {
    let data;
    try { data = JSON.parse(text); } catch {
      return sidecarWrap('sidecar-table', text,
        '<div class="sidecar-body"><span style="color:var(--red);font-size:12px;font-family:var(--font-mono)">invalid json</span></div>');
    }
    if (!Array.isArray(data) || data.length === 0) {
      return sidecarWrap('sidecar-table', text,
        '<div class="sidecar-body"><span style="color:var(--text-dim);font-size:12px;font-family:var(--font-mono)">empty dataset</span></div>');
    }

    const tableId = 'sctable-' + (++mermaidIdCounter);
    const cols = Object.keys(data[0]);
    let thead = '<tr>' + cols.map(c =>
      `<th data-col="${esc(c)}" onclick="sortSidecarTable(this)">${esc(c)}<span class="sort-arrow">&#9650;</span></th>`
    ).join('') + '</tr>';
    let tbody = data.map(row =>
      '<tr>' + cols.map(c => `<td title="${esc(String(row[c] ?? ''))}">${esc(String(row[c] ?? ''))}</td>`).join('') + '</tr>'
    ).join('');

    const body = `<div class="sc-table-filter"><input type="text" placeholder="filter..." oninput="filterSidecarTable(this, '${tableId}')"></div>`
      + `<div class="sidecar-body" style="padding:0;overflow-x:auto"><table id="${tableId}"><thead>${thead}</thead><tbody>${tbody}</tbody></table></div>`
      + `<div class="sc-table-info">${data.length} row${data.length !== 1 ? 's' : ''} &middot; ${cols.length} col${cols.length !== 1 ? 's' : ''}</div>`;

    return sidecarWrap('sidecar-table', text, body);
  }

  function renderSidecarDiff(text) {
    const lines = text.split('\n');
    let lineNum = 0;
    const rendered = lines.map(line => {
      let cls = 'diff-ctx';
      let gutter = '';
      if (line.startsWith('@@')) {
        cls = 'diff-hunk';
        const match = line.match(/@@ -\d+(?:,\d+)? \+(\d+)/);
        if (match) lineNum = parseInt(match[1], 10) - 1;
        gutter = '...';
      } else if (line.startsWith('+')) {
        cls = 'diff-add';
        lineNum++;
        gutter = lineNum;
      } else if (line.startsWith('-')) {
        cls = 'diff-del';
        gutter = '';
      } else if (line.startsWith('diff ') || line.startsWith('index ') || line.startsWith('---') || line.startsWith('+++')) {
        cls = 'diff-hunk';
        gutter = '';
      } else {
        lineNum++;
        gutter = lineNum;
      }
      return `<div class="diff-line ${cls}"><span class="diff-gutter">${gutter}</span><span class="diff-content">${esc(line)}</span></div>`;
    }).join('');

    return sidecarWrap('sidecar-diff', text,
      `<div class="sidecar-body">${rendered}</div>`);
  }

  function renderSidecarJson(text) {
    let data;
    try { data = JSON.parse(text); } catch {
      return sidecarWrap('sidecar-json', text,
        '<div class="sidecar-body"><span style="color:var(--red);font-size:12px;font-family:var(--font-mono)">invalid json</span></div>');
    }

    function renderNode(value, key, indent) {
      if (value === null) {
        const keyPart = key !== undefined ? `<span class="jt-key">"${esc(String(key))}"</span>: ` : '';
        return `<div class="jt-row">${keyPart}<span class="jt-null">null</span></div>`;
      }
      if (typeof value === 'string') {
        const keyPart = key !== undefined ? `<span class="jt-key">"${esc(String(key))}"</span>: ` : '';
        return `<div class="jt-row">${keyPart}<span class="jt-str">"${esc(value)}"</span></div>`;
      }
      if (typeof value === 'number') {
        const keyPart = key !== undefined ? `<span class="jt-key">"${esc(String(key))}"</span>: ` : '';
        return `<div class="jt-row">${keyPart}<span class="jt-num">${value}</span></div>`;
      }
      if (typeof value === 'boolean') {
        const keyPart = key !== undefined ? `<span class="jt-key">"${esc(String(key))}"</span>: ` : '';
        return `<div class="jt-row">${keyPart}<span class="jt-bool">${value}</span></div>`;
      }
      if (Array.isArray(value)) {
        const keyPart = key !== undefined ? `<span class="jt-key">"${esc(String(key))}"</span>: ` : '';
        if (value.length === 0) return `<div class="jt-row">${keyPart}<span class="jt-bracket">[]</span></div>`;
        const summary = `<span class="jt-summary">[${value.length} items]</span>`;
        const children = value.map((v, i) => renderNode(v, undefined, indent + 1)).join('');
        return `<div class="jt-row">${keyPart}<span class="jt-toggle" onclick="toggleJsonNode(this)">&#9660;</span><span class="jt-bracket">[</span>${summary}<div class="jt-children">${children}</div><div class="jt-row"><span class="jt-bracket">]</span></div></div>`;
      }
      if (typeof value === 'object') {
        const keyPart = key !== undefined ? `<span class="jt-key">"${esc(String(key))}"</span>: ` : '';
        const keys = Object.keys(value);
        if (keys.length === 0) return `<div class="jt-row">${keyPart}<span class="jt-bracket">{}</span></div>`;
        const summary = `<span class="jt-summary">{${keys.length} keys}</span>`;
        const children = keys.map(k => renderNode(value[k], k, indent + 1)).join('');
        return `<div class="jt-row">${keyPart}<span class="jt-toggle" onclick="toggleJsonNode(this)">&#9660;</span><span class="jt-bracket">{</span>${summary}<div class="jt-children">${children}</div><div class="jt-row"><span class="jt-bracket">}</span></div></div>`;
      }
      return '';
    }

    const tree = renderNode(data, undefined, 0);
    return sidecarWrap('sidecar-json', text,
      `<div class="sidecar-body">${tree}</div>`);
  }

  function renderSidecarProgress(text) {
    let data;
    try { data = JSON.parse(text); } catch {
      return sidecarWrap('sidecar-progress', text,
        '<div class="sidecar-body"><span style="color:var(--red);font-size:12px;font-family:var(--font-mono)">invalid json</span></div>');
    }
    const label = data.label || 'Progress';
    const percent = Math.max(0, Math.min(100, Number(data.percent) || 0));
    const status = data.status || 'running';
    const statusClass = ['running','done','error','pending'].includes(status) ? status : 'running';

    return sidecarWrap('sidecar-progress', text,
      `<div class="sidecar-body"><span class="sp-status-dot ${statusClass}"></span><div class="sp-info"><div class="sp-label">${esc(label)}</div><div class="sp-bar-track"><div class="sp-bar-fill ${statusClass}" style="width:${percent}%"></div></div></div><span class="sp-percent">${percent}%</span></div>`
    );
  }

  // Sidecar component dispatch map
  const sidecarRenderers = {
    'sidecar-mermaid': renderSidecarMermaid,
    'sidecar-table': renderSidecarTable,
    'sidecar-diff': renderSidecarDiff,
    'sidecar-json': renderSidecarJson,
    'sidecar-progress': renderSidecarProgress,
  };

  // Global interaction handlers for sidecar components
  function toggleJsonNode(el) {
    el.classList.toggle('collapsed');
    const children = el.parentElement.querySelector('.jt-children');
    if (children) children.classList.toggle('hidden');
  }

  function sortSidecarTable(th) {
    const table = th.closest('table');
    const colIdx = Array.from(th.parentElement.children).indexOf(th);
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const isAsc = th.classList.contains('sorted') && th.dataset.dir === 'asc';
    const dir = isAsc ? 'desc' : 'asc';

    // Clear all sorted states
    th.parentElement.querySelectorAll('th').forEach(h => {
      h.classList.remove('sorted'); h.dataset.dir = '';
      h.querySelector('.sort-arrow').innerHTML = '&#9650;';
    });
    th.classList.add('sorted');
    th.dataset.dir = dir;
    th.querySelector('.sort-arrow').innerHTML = dir === 'asc' ? '&#9650;' : '&#9660;';

    rows.sort((a, b) => {
      const av = a.children[colIdx]?.textContent || '';
      const bv = b.children[colIdx]?.textContent || '';
      const an = parseFloat(av), bn = parseFloat(bv);
      if (!isNaN(an) && !isNaN(bn)) return dir === 'asc' ? an - bn : bn - an;
      return dir === 'asc' ? av.localeCompare(bv) : bv.localeCompare(av);
    });
    rows.forEach(r => tbody.appendChild(r));
  }

  function filterSidecarTable(input, tableId) {
    const filter = input.value.toLowerCase();
    const table = document.getElementById(tableId);
    if (!table) return;
    const rows = table.querySelectorAll('tbody tr');
    let visible = 0;
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const show = text.includes(filter);
      row.style.display = show ? '' : 'none';
      if (show) visible++;
    });
    const info = table.closest('.sidecar')?.querySelector('.sc-table-info');
    if (info) {
      const total = rows.length;
      info.textContent = filter ? `${visible} of ${total} rows` : `${total} row${total !== 1 ? 's' : ''}`;
    }
  }

  const renderer = new marked.Renderer();
  renderer.code = function({ text, lang }) {
    // Check for sidecar component
    if (lang && sidecarRenderers[lang]) {
      return sidecarRenderers[lang](text);
    }

    // Default code block rendering
    const langLabel = lang || '';
    const highlighted = lang && hljs.getLanguage(lang)
      ? hljs.highlight(text, { language: lang }).value
      : hljs.highlightAuto(text).value;
    const escaped = text.replace(/"/g, '&quot;').replace(/</g, '&lt;');
    return `<pre><div class="code-header"><span class="code-lang">${esc(langLabel)}</span><button class="copy-btn" onclick="copyCode(this)" data-code="${escaped}">copy</button></div><code>${highlighted}</code></pre>`;
  };
  marked.setOptions({ renderer });

  // === WebSocket ===
  function connectWS() {
    ws = new WebSocket(WS_URL);
    ws.onopen = () => { $('status-dot').className = 'status-dot connected'; $('status-text').textContent = 'connected'; };
    ws.onclose = () => { $('status-dot').className = 'status-dot disconnected'; $('status-text').textContent = 'reconnecting'; setTimeout(connectWS, 2000); };
    ws.onerror = () => ws.close();
    ws.onmessage = (e) => {
      const m = JSON.parse(e.data);
      if (m.type === 'init') onInit(m.data);
      if (m.type === 'session_started') onSessionStarted(m.data);
      if (m.type === 'session_ended') onSessionEnded(m.data);
      if (m.type === 'new_response') onNewResponse(m.data);
      if (m.type === 'annotation_added') onAnnotationAdded(m.data);
      if (m.type === 'session_git_status') onSessionGitStatus(m.data);
      if (m.type === 'session_stats_update') onSessionStatsUpdate(m.data);
    };
  }

  function onInit(data) {
    sessions.clear(); responses.clear(); allAnnotations.clear();
    (data.sessions || []).forEach(s => sessions.set(s.sessionId, s));
    for (const [sid, r] of Object.entries(data.responses || {})) responses.set(sid, r);
    for (const [sid, a] of Object.entries(data.annotations || {})) allAnnotations.set(sid, a);
    renderTabs();
    if (sessions.size > 0 && !activeSessionId) {
      const latest = [...sessions.values()].sort((a,b) => b.lastActivity - a.lastActivity)[0];
      switchSession(latest.sessionId);
    }
    updateStatus();
    loadConfig();
  }

  function onSessionStarted(meta) {
    sessions.set(meta.sessionId, meta);
    if (!responses.has(meta.sessionId)) responses.set(meta.sessionId, []);
    if (!allAnnotations.has(meta.sessionId)) allAnnotations.set(meta.sessionId, []);
    renderTabs();
    switchSession(meta.sessionId);
    updateStatus();
  }

  function onSessionEnded(data) {
    const m = sessions.get(data.sessionId);
    if (m) m._ended = true;
    renderTabs();
  }

  function onNewResponse(resp) {
    const sid = resp.sessionId || 'unknown';
    if (!responses.has(sid)) responses.set(sid, []);
    responses.get(sid).push(resp);
    const m = sessions.get(sid);
    if (m) { m.lastActivity = Date.now(); m.turnCount = (m.turnCount || 0) + 1; }
    if (sid === activeSessionId) {
      renderResponse(resp, responses.get(sid).length);
      $('empty-state').style.display = 'none';
      renderSessionHeader();
      if (autoScroll) scrollBottom();
    }
    renderTabs(); updateStatus();
  }

  function onAnnotationAdded(ann) {
    const sid = ann.sessionId || 'unknown';
    if (!allAnnotations.has(sid)) allAnnotations.set(sid, []);
    allAnnotations.get(sid).push(ann);
    if (sid === activeSessionId) renderAnnotations();
  }

  function onSessionGitStatus(data) {
    const m = sessions.get(data.sessionId);
    if (m) {
      m.gitStatus = data.gitStatus;
      if (data.gitStatus && data.gitStatus.branch) {
        m.gitBranch = data.gitStatus.branch;
      }
    }
    if (data.sessionId === activeSessionId) renderSessionHeader();
  }

  function onSessionStatsUpdate(data) {
    const m = sessions.get(data.sessionId);
    if (!m) return;
    m.totalTokensIn = data.totalTokensIn;
    m.totalTokensOut = data.totalTokensOut;
    m.turnCount = data.turnCount;
    m.lastActivity = Date.now();
    if (data.sessionId === activeSessionId) renderSessionHeader();
  }

  // === Config ===
  async function loadConfig() {
    try {
      const resp = await fetch(`${API}/api/config`);
      globalConfig = await resp.json();
      renderSystem();
    } catch {}
  }

  // Build a single accordion item
  // options: { label, meta, dotClass, id, content }
  function sysAccordion({ label, meta, dotClass, id, content }) {
    const dot = dotClass ? `<span class="sys-acc-dot ${dotClass}"></span>` : '';
    const metaSpan = meta ? `<span class="sys-acc-meta">${esc(String(meta))}</span>` : '';
    return `<div class="sys-accordion">
      <button class="sys-acc-trigger" aria-expanded="false" aria-controls="${id}" tabindex="0"
        onclick="toggleAccordion(this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleAccordion(this)}">
        <span class="sys-acc-chevron">&rsaquo;</span>
        ${dot}
        <span class="sys-acc-label">${esc(label)}</span>
        ${metaSpan}
      </button>
      <div class="sys-acc-body" id="${id}">
        <div class="sys-acc-content">${content}</div>
      </div>
    </div>`;
  }

  function toggleAccordion(trigger) {
    const expanded = trigger.getAttribute('aria-expanded') === 'true';
    trigger.setAttribute('aria-expanded', String(!expanded));
    const bodyId = trigger.getAttribute('aria-controls');
    const body = $(bodyId);
    if (body) body.classList.toggle('expanded', !expanded);
  }

  function renderSystem() {
    const c = $('system-content');
    if (!globalConfig) { c.innerHTML = '<div class="sidebar-hint">unavailable</div>'; return; }

    const g = globalConfig;
    const stats = g.stats || {};
    const env = Object.entries(g.settings?.env || {});

    let html = '';

    // Stats section (unchanged — not interactive)
    if (stats.totalSessions) {
      html += `<div class="sys-section"><div class="sys-section-title">stats</div>
        <div class="sys-stats-grid">
          <div class="sys-stat-card"><div class="sys-stat animated-num" id="sys-total-sessions" data-raw-value="${stats.totalSessions}">${formatNum(stats.totalSessions)}</div><div class="sys-stat-label">sessions</div></div>
          <div class="sys-stat-card"><div class="sys-stat animated-num" id="sys-total-messages" data-raw-value="${stats.totalMessages}">${formatNum(stats.totalMessages)}</div><div class="sys-stat-label">messages</div></div>
        </div>
        ${stats.firstSessionDate ? `<div class="sys-item"><span class="name">first session</span><span class="val">${new Date(stats.firstSessionDate).toLocaleDateString()}</span></div>` : ''}
      </div>`;
    }

    if (g.claudeVersion) {
      html += `<div class="sys-section"><div class="sys-section-title">version</div>
        <div class="sys-item"><span class="name">claude code</span><span class="val">${esc(g.claudeVersion)}</span></div>
      </div>`;
    }

    // === Skills section (interactive) ===
    const richSkills = g.richSkills || [];
    if (richSkills.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">skills</div>`;
      richSkills.forEach((skill, i) => {
        const src = skill.source === 'user' ? 'user' : skill.source.split('@')[0];
        const invocable = skill.modelInvocable ? 'auto' : 'manual';
        let details = '';
        if (skill.description) {
          details += `<div class="detail-row"><span class="detail-label">desc</span><span class="detail-value">${esc(skill.description)}</span></div>`;
        }
        details += `<div class="detail-row"><span class="detail-label">invoke</span><span class="detail-value">${invocable}</span></div>`;
        details += `<div class="detail-row"><span class="detail-label">source</span><span class="detail-value"><span class="mini-pill source-${skill.source === 'user' ? 'global' : 'plugin'}">${esc(src)}</span></span></div>`;
        if (skill.argumentHint) {
          details += `<div class="detail-row"><span class="detail-label">args</span><span class="detail-value">${esc(skill.argumentHint)}</span></div>`;
        }
        details += `<div class="detail-row"><span class="detail-label">path</span><span class="detail-value path">${esc(skill.path)}</span></div>`;

        html += sysAccordion({
          label: skill.name,
          meta: src,
          dotClass: skill.modelInvocable ? 'active' : 'inactive',
          id: `skill-${i}`,
          content: details,
        });
      });
      html += '</div>';
    }

    // === Plugins section (interactive) ===
    const richPlugins = g.plugins || [];
    if (richPlugins.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">plugins</div>`;
      richPlugins.forEach((plugin, i) => {
        let details = '';
        if (plugin.description) {
          details += `<div class="detail-row"><span class="detail-label">desc</span><span class="detail-value">${esc(plugin.description)}</span></div>`;
        }
        if (plugin.version) {
          details += `<div class="detail-row"><span class="detail-label">version</span><span class="detail-value">${esc(plugin.version)}</span></div>`;
        }
        if (plugin.author) {
          details += `<div class="detail-row"><span class="detail-label">author</span><span class="detail-value">${esc(plugin.author)}</span></div>`;
        }
        details += `<div class="detail-row"><span class="detail-label">market</span><span class="detail-value">${esc(plugin.marketplace)}</span></div>`;
        if (plugin.homepage) {
          details += `<div class="detail-row"><span class="detail-label">url</span><span class="detail-value">${esc(plugin.homepage)}</span></div>`;
        }
        // Skills provided
        if (plugin.skills && plugin.skills.length > 0) {
          details += `<div class="detail-row"><span class="detail-label">skills</span><span class="detail-value"><div class="detail-pills">${
            plugin.skills.map(s => `<span class="mini-pill">${esc(s)}</span>`).join('')
          }</div></span></div>`;
        }
        // Hooks registered
        const hookEntries = Object.entries(plugin.hooks || {});
        if (hookEntries.length > 0) {
          details += `<div class="detail-row"><span class="detail-label">hooks</span><span class="detail-value"><div class="detail-pills">${
            hookEntries.map(([ev, ct]) => `<span class="mini-pill hook">${esc(ev)} (${ct})</span>`).join('')
          }</div></span></div>`;
        }

        html += sysAccordion({
          label: plugin.name,
          meta: plugin.marketplace,
          dotClass: plugin.enabled ? 'enabled' : 'disabled',
          id: `plugin-${i}`,
          content: details,
        });
      });
      html += '</div>';
    }

    // === Hooks section (interactive, grouped by event) ===
    const richHooks = g.richHooks || {};
    const hookEvents = Object.keys(richHooks);
    if (hookEvents.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">hooks</div>`;
      let hookIdx = 0;
      hookEvents.forEach(event => {
        html += `<div class="sys-hook-group">${esc(event)}</div>`;
        const hooks = richHooks[event] || [];
        hooks.forEach(hook => {
          // Extract script name from command for display
          const cmdParts = hook.command.split('/');
          const scriptName = cmdParts[cmdParts.length - 1] || hook.command;
          const sourcePill = hook.source === 'global' ? 'source-global' : 'source-plugin';
          const sourceLabel = hook.source === 'global' ? 'global' : hook.source.split('@')[0];

          let details = '';
          details += `<div class="detail-row"><span class="detail-label">cmd</span><span class="detail-value path">${esc(hook.command)}</span></div>`;
          if (hook.timeout) {
            details += `<div class="detail-row"><span class="detail-label">timeout</span><span class="detail-value">${hook.timeout}ms</span></div>`;
          }
          if (hook.matcher) {
            details += `<div class="detail-row"><span class="detail-label">matcher</span><span class="detail-value">${esc(hook.matcher)}</span></div>`;
          }
          details += `<div class="detail-row"><span class="detail-label">source</span><span class="detail-value"><span class="mini-pill ${sourcePill}">${esc(sourceLabel)}</span></span></div>`;

          html += sysAccordion({
            label: scriptName,
            meta: hook.timeout ? `${hook.timeout}ms` : '',
            dotClass: 'active',
            id: `hook-${hookIdx}`,
            content: details,
          });
          hookIdx++;
        });
      });
      html += '</div>';
    }

    // === MCP Servers section (interactive) ===
    const richMcp = g.richMcpServers || [];
    if (richMcp.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">mcp</div>`;
      richMcp.forEach((server, i) => {
        let details = '';
        if (server.command) {
          details += `<div class="detail-row"><span class="detail-label">cmd</span><span class="detail-value path">${esc(server.command)}</span></div>`;
        }
        if (server.args && server.args.length > 0) {
          details += `<div class="detail-row"><span class="detail-label">args</span><span class="detail-value path">${esc(server.args.join(' '))}</span></div>`;
        }
        details += `<div class="detail-row"><span class="detail-label">type</span><span class="detail-value">${esc(server.type)}</span></div>`;
        if (server.env && server.env.length > 0) {
          details += `<div class="detail-row"><span class="detail-label">env</span><span class="detail-value"><div class="detail-pills">${
            server.env.map(k => `<span class="mini-pill source-global">${esc(k)}</span>`).join('')
          }</div></span></div>`;
        }

        html += sysAccordion({
          label: server.name,
          meta: server.type,
          dotClass: 'connected',
          id: `mcp-${i}`,
          content: details,
        });
      });
      html += '</div>';
    }

    // Env section (non-interactive, same as before)
    if (env.length > 0) {
      html += `<div class="sys-section"><div class="sys-section-title">env</div>`;
      env.forEach(([k, v]) => {
        html += `<div class="sys-item"><span class="name" style="font-family:var(--font-mono);font-size:10px">${esc(k)}</span><span class="val">${esc(String(v))}</span></div>`;
      });
      html += '</div>';
    }

    // Token usage section (non-interactive, same as before)
    if (stats.modelUsage) {
      html += `<div class="sys-section"><div class="sys-section-title">token usage</div>`;
      for (const [model, usage] of Object.entries(stats.modelUsage)) {
        const u = usage;
        const total = (u.inputTokens || 0) + (u.outputTokens || 0) + (u.cacheReadInputTokens || 0);
        html += `<div class="sys-item"><span class="name" style="font-size:10px">${esc(model.replace('claude-', ''))}</span><span class="val">${formatTokens(total)}</span></div>`;
      }
      html += '</div>';
    }

    // Mise section (appended when data is available)
    html += renderMiseSection();

    c.innerHTML = html;
  }

  // === Mise ===
  async function loadMise() {
    if (miseLoaded) return;
    miseLoaded = true;
    try {
      const resp = await fetch(`${API}/api/mise`);
      miseData = await resp.json();
      renderSystem();
    } catch { miseData = null; }
  }

  function renderMiseSection() {
    if (!miseData || !miseData.available) return '';
    let html = '';
    const COLLAPSE_THRESHOLD = 15;

    // Tools section
    const toolEntries = Object.entries(miseData.tools || {});
    if (toolEntries.length > 0) {
      html += '<div class="sys-section"><div class="sys-section-title">mise tools</div>';
      // Flatten: each tool name maps to its active versions
      const toolPills = [];
      for (const [name, versions] of toolEntries) {
        const active = versions.filter(v => v.active);
        const display = active.length > 0 ? active : [versions[0]];
        for (const v of display) {
          toolPills.push({ name, version: v.version, active: v.active });
        }
      }
      const showInitial = toolPills.length > COLLAPSE_THRESHOLD ? 10 : toolPills.length;
      const miseToolsId = 'mise-tools-list';
      for (let i = 0; i < showInitial; i++) {
        const p = toolPills[i];
        html += `<span class="sys-pill on">${esc(p.name)} ${esc(p.version)}</span>`;
      }
      if (toolPills.length > COLLAPSE_THRESHOLD) {
        html += `<span id="${miseToolsId}" style="display:none">`;
        for (let i = showInitial; i < toolPills.length; i++) {
          const p = toolPills[i];
          html += `<span class="sys-pill on">${esc(p.name)} ${esc(p.version)}</span>`;
        }
        html += '</span>';
        html += `<br><button class="mise-toggle" onclick="toggleMiseList('${miseToolsId}', this, ${toolPills.length - showInitial})">show ${toolPills.length - showInitial} more</button>`;
      }
      html += '</div>';
    }

    // Environment section
    const envEntries = Object.entries(miseData.env || {});
    if (envEntries.length > 0) {
      html += '<div class="sys-section"><div class="sys-section-title">mise env</div>';
      const showInitialEnv = envEntries.length > COLLAPSE_THRESHOLD ? 10 : envEntries.length;
      const miseEnvId = 'mise-env-list';
      for (let i = 0; i < showInitialEnv; i++) {
        const [k, v] = envEntries[i];
        const valClass = v.masked ? 'mise-masked' : 'val';
        html += `<div class="sys-item"><span class="name" style="font-family:var(--font-mono);font-size:10px;max-width:45%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(k)}">${esc(k)}</span><span class="${valClass}" title="${v.masked ? 'masked' : esc(v.value)}">${esc(v.value)}</span></div>`;
      }
      if (envEntries.length > COLLAPSE_THRESHOLD) {
        html += `<div id="${miseEnvId}" style="display:none">`;
        for (let i = showInitialEnv; i < envEntries.length; i++) {
          const [k, v] = envEntries[i];
          const valClass = v.masked ? 'mise-masked' : 'val';
          html += `<div class="sys-item"><span class="name" style="font-family:var(--font-mono);font-size:10px;max-width:45%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(k)}">${esc(k)}</span><span class="${valClass}" title="${v.masked ? 'masked' : esc(v.value)}">${esc(v.value)}</span></div>`;
        }
        html += '</div>';
        html += `<button class="mise-toggle" onclick="toggleMiseList('${miseEnvId}', this, ${envEntries.length - showInitialEnv})">show ${envEntries.length - showInitialEnv} more</button>`;
      }
      html += '</div>';
    }

    // Config files section
    const configEntries = Object.entries(miseData.configFiles || {});
    if (configEntries.length > 0) {
      html += '<div class="sys-section"><div class="sys-section-title">mise config</div>';
      for (const [filename] of configEntries) {
        html += `<button class="mise-config-link" onclick="openConfigModal('${esc(filename)}')">${esc(filename)}</button>`;
      }
      html += '</div>';
    }

    return html;
  }

  function toggleMiseList(id, btn, count) {
    const el = document.getElementById(id);
    if (!el) return;
    const hidden = el.style.display === 'none';
    el.style.display = hidden ? '' : 'none';
    btn.textContent = hidden ? 'show less' : `show ${count} more`;
  }

  function openConfigModal(filename) {
    const content = miseData && miseData.configFiles && miseData.configFiles[filename];
    if (!content) return;
    $('config-modal-title').textContent = filename;
    // Use highlight.js for TOML if available, otherwise plain text
    let highlighted;
    try {
      highlighted = hljs.getLanguage('toml')
        ? hljs.highlight(content, { language: 'toml' }).value
        : hljs.highlightAuto(content).value;
    } catch { highlighted = esc(content); }
    $('config-modal-body').innerHTML = '<pre><code>' + highlighted + '</code></pre>';
    $('config-modal').classList.add('visible');
  }

  function closeConfigModal() {
    $('config-modal').classList.remove('visible');
  }

  // === Tabs ===
  const prevBadgeCounts = new Map();
  const TAB_RECENT_MS = 5 * 60 * 1000;     // 5 min
  const TAB_EXPIRY_MS = 6 * 60 * 60 * 1000; // 6 hrs
  const TAB_MAX_VISIBLE = 8;

  function tabState(session) {
    if (session._ended) return 'ended';
    const age = Date.now() - (session.lastActivity || session.startedAt || 0);
    if (age < TAB_RECENT_MS) return 'recent';
    return 'idle';
  }

  function tabVisible(session) {
    if (session.sessionId === activeSessionId) return true;
    const age = Date.now() - (session.lastActivity || session.startedAt || 0);
    return age < TAB_EXPIRY_MS;
  }

  function formatAge(ts) {
    const diff = Date.now() - ts;
    if (diff < 60000) return 'now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    return Math.floor(diff / 86400000) + 'd ago';
  }

  function renderTabs() {
    const bar = $('tab-bar-tabs');
    bar.innerHTML = '';
    const badgesToAnimate = [];

    // Sort all sessions by last activity, most recent first
    const sorted = [...sessions.values()].sort((a, b) =>
      (b.lastActivity || b.startedAt || 0) - (a.lastActivity || a.startedAt || 0)
    );

    const visible = sorted.filter(tabVisible);
    const hidden = sorted.filter(s => !tabVisible(s));

    const barTabs = visible.slice(0, TAB_MAX_VISIBLE);
    const overflowTabs = visible.slice(TAB_MAX_VISIBLE);
    const allOverflow = [...overflowTabs, ...hidden];

    barTabs.forEach(s => {
      bar.appendChild(buildTabEl(s, badgesToAnimate));
    });

    if (allOverflow.length > 0) {
      const overflowBtn = document.createElement('div');
      overflowBtn.className = 'tab-overflow-btn';
      overflowBtn.textContent = '+' + allOverflow.length;
      overflowBtn.onclick = (e) => {
        e.stopPropagation();
        toggleOverflowDropdown();
      };
      bar.appendChild(overflowBtn);

      const dropdown = document.createElement('div');
      dropdown.className = 'tab-overflow-dropdown';
      dropdown.id = 'tab-overflow-dropdown';
      allOverflow.forEach(s => {
        const item = document.createElement('div');
        const state = tabState(s);
        item.className = 'tab-overflow-item state-' + state;
        const label = sessionLabel(s);
        const lastTs = s.lastActivity || s.startedAt || 0;
        item.innerHTML = `<span class="toi-dot"></span><span class="toi-label">${esc(label)}</span><span class="toi-time">${formatAge(lastTs)}</span>`;
        item.onclick = () => {
          switchSession(s.sessionId);
          closeOverflowDropdown();
        };
        dropdown.appendChild(item);
      });
      bar.appendChild(dropdown);
    }

    // Animate badge counts after DOM is built
    badgesToAnimate.forEach(({ id, oldVal, newVal }) => {
      const el = $(id);
      if (el) animateValue(el, oldVal, newVal, 400, String);
    });
  }

  function buildTabEl(session, badgesToAnimate) {
    const state = tabState(session);
    const isActive = session.sessionId === activeSessionId;
    const t = document.createElement('div');
    t.className = 'tab state-' + state + (isActive ? ' active' : '');
    const label = sessionLabel(session);
    const rc = (responses.get(session.sessionId) || []).length;
    const badgeId = 'tab-badge-' + session.sessionId.slice(0,8);
    const badge = rc > 0 && !isActive
      ? `<span class="tab-badge animated-num" id="${badgeId}" data-raw-value="${rc}">${rc}</span>` : '';
    t.innerHTML = `<span class="tab-dot"></span>${esc(label)}${badge}`;
    t.onclick = () => switchSession(session.sessionId);

    // Queue animation if badge value changed
    if (badgesToAnimate && rc > 0 && !isActive) {
      const prev = prevBadgeCounts.get(session.sessionId) || 0;
      if (prev !== rc && prev > 0) {
        badgesToAnimate.push({ id: badgeId, oldVal: prev, newVal: rc });
      }
      prevBadgeCounts.set(session.sessionId, rc);
    }
    return t;
  }

  function toggleOverflowDropdown() {
    const dd = $('tab-overflow-dropdown');
    if (dd) dd.classList.toggle('visible');
  }

  function closeOverflowDropdown() {
    const dd = $('tab-overflow-dropdown');
    if (dd) dd.classList.remove('visible');
  }

  // Close overflow dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.tab-overflow-btn') && !e.target.closest('.tab-overflow-dropdown')) {
      closeOverflowDropdown();
    }
  });

  function sessionLabel(m) {
    if (m.gitRepo) return m.gitRepo.split('/').pop();
    if (m.cwd) { const p = m.cwd.split('/'); return p[p.length-1] || p[p.length-2] || 'session'; }
    return m.sessionId.slice(0,8);
  }

  function switchSession(sid) {
    activeSessionId = sid;
    headerSessionId = null; // Force full header rebuild on session switch
    renderTabs(); renderSessionHeader(); renderAllResponses(); renderAnnotations();
  }

  // === Session Header ===
  // Track which session the header was last built for
  let headerSessionId = null;

  function renderSessionHeader() {
    const h = $('session-header');
    const m = sessions.get(activeSessionId);
    if (!m) { h.style.display = 'none'; headerSessionId = null; return; }
    h.style.display = 'block';

    // If switching sessions or first render, rebuild the full header
    if (headerSessionId !== activeSessionId) {
      headerSessionId = activeSessionId;
      const model = (m.model||'unknown').replace('claude-','').replace(/-\d+$/,'');
      const started = new Date(m.startedAt).toLocaleTimeString();
      h.innerHTML = `
        <div class="sh-row1">
          <span class="sh-cwd">${esc(m.cwd||'')}</span>
          <span class="sh-pill model">${esc(model)}</span>
          <span class="sh-pill perm">${esc(m.permissionMode||'default')}</span>
          ${m.source && m.source !== 'startup' ? `<span class="sh-pill source">${esc(m.source)}</span>` : ''}
        </div>
        <div class="sh-grid">
          ${mi('branch', m.gitBranch||'-')}${mi('repo', m.gitRepo||'-')}${mi('started', started)}
          ${miAnim('turns', m.turnCount||0, 'sh-turns', formatNum)}${miAnim('in', m.totalTokensIn||0, 'sh-tok-in', formatTokens)}${miAnim('out', m.totalTokensOut||0, 'sh-tok-out', formatTokens)}
          ${m.claudeVersion ? mi('cc', m.claudeVersion) : ''}
        </div>
        ${renderGitStatus(m.gitStatus)}`;
      return;
    }

    // Same session — animate the changing numeric values
    updateAnimatedNum($('sh-turns'), m.turnCount || 0, formatNum);
    updateAnimatedNum($('sh-tok-in'), m.totalTokensIn || 0, formatTokens);
    updateAnimatedNum($('sh-tok-out'), m.totalTokensOut || 0, formatTokens);
    // Re-render git status (it changes independently of numeric stats)
    const gitContainer = h.querySelector('.sh-git');
    const newGit = renderGitStatus(m.gitStatus);
    if (newGit) {
      if (gitContainer) gitContainer.outerHTML = newGit;
      else h.insertAdjacentHTML('beforeend', newGit);
    } else if (gitContainer) {
      gitContainer.remove();
    }
  }

  function renderGitStatus(gs) {
    if (!gs) return '';
    const parts = [];

    const dotClass = gs.conflicted > 0 ? 'conflict' :
                     (gs.staged + gs.modified + gs.untracked > 0) ? 'dirty' : 'clean';
    parts.push(`<span class="sh-git-dot ${dotClass}"></span>`);
    parts.push(`<span class="sh-git-branch">${esc(gs.branch || '(detached)')}</span>`);

    const syncParts = [];
    if (gs.ahead > 0) syncParts.push(`<span class="ahead">&uarr;${gs.ahead}</span>`);
    if (gs.behind > 0) syncParts.push(`<span class="behind">&darr;${gs.behind}</span>`);
    if (syncParts.length > 0) {
      parts.push(`<span class="sh-git-sync">${syncParts.join(' ')}</span>`);
    }

    const fileParts = [];
    if (gs.staged > 0) fileParts.push(`<span class="gs gs-staged">+${gs.staged}</span>`);
    if (gs.modified > 0) fileParts.push(`<span class="gs gs-modified">~${gs.modified}</span>`);
    if (gs.untracked > 0) fileParts.push(`<span class="gs gs-untracked">?${gs.untracked}</span>`);
    if (gs.conflicted > 0) fileParts.push(`<span class="gs gs-conflicted">!${gs.conflicted}</span>`);
    if (fileParts.length > 0) {
      parts.push(`<span class="sh-git-files">${fileParts.join('')}</span>`);
    } else if (dotClass === 'clean') {
      parts.push(`<span class="sh-git-clean">clean</span>`);
    }

    return `<div class="sh-git">${parts.join('')}</div>`;
  }

  function mi(l,v) { return `<span class="mi"><span class="ml">${l}</span><span class="mv">${esc(String(v))}</span></span>`; }
  function miAnim(l, rawVal, id, formatter) {
    return `<span class="mi"><span class="ml">${l}</span><span class="mv animated-num" id="${id}" data-raw-value="${rawVal}">${formatter(rawVal)}</span></span>`;
  }

  // === Responses ===
  function renderAllResponses() {
    const c = $('responses'); c.innerHTML = '';
    const r = responses.get(activeSessionId) || [];
    if (!r.length) { $('empty-state').style.display = 'flex'; return; }
    $('empty-state').style.display = 'none';
    r.forEach((resp,i) => renderResponse(resp, i+1));
  }

  function renderResponse(resp, num) {
    const d = document.createElement('div');
    d.className = 'response-entry';
    d.dataset.responseId = resp.id;
    d.dataset.sessionId = resp.sessionId;
    const t = new Date(resp.timestamp).toLocaleTimeString();
    d.innerHTML = `<div class="response-meta"><span class="response-num">${num}</span><span>${t}</span></div><div class="md">${marked.parse(resp.content||'')}</div>`;
    $('responses').appendChild(d);
  }

  // === Annotations ===
  function renderAnnotations() {
    const list = $('annotation-list');
    const anns = allAnnotations.get(activeSessionId) || [];
    $('annotation-count').textContent = anns.length;
    if (!anns.length) {
      list.innerHTML = '<div class="sidebar-hint">Select text in a response to annotate it.<br>Annotations inject as context on your next prompt.</div>';
      return;
    }
    list.innerHTML = anns.map(a => `
      <div class="annotation-card" data-id="${a.id}">
        <div class="sel">${esc(a.selectedText)}</div>
        <div class="cmt">${esc(a.comment)}</div>
        <div class="meta"><span>${new Date(a.timestamp).toLocaleTimeString()}</span><button class="del-btn" onclick="delAnnotation('${a.id}')">remove</button></div>
      </div>`).join('');
  }

  async function delAnnotation(id) {
    await fetch(`${API}/api/annotations?action=delete`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id}) });
    for (const [,a] of allAnnotations) { const i = a.findIndex(x=>x.id===id); if (i!==-1) { a.splice(i,1); break; } }
    renderAnnotations();
  }

  // === Sidebar Tabs ===
  function switchSidebarTab(el) {
    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    $(el.dataset.panel).classList.add('active');
    // Lazy-load mise data when System tab is opened
    if (el.dataset.panel === 'system-panel') loadMise();
  }

  // === Annotation Popup ===
  document.addEventListener('mouseup', (e) => {
    const sel = window.getSelection(); const txt = sel.toString().trim();
    if (!txt || txt.length < 3) { hidePopup(); return; }
    const entry = e.target.closest('.response-entry');
    if (!entry) { hidePopup(); return; }
    pendingSelection = { text: txt, responseId: entry.dataset.responseId, sessionId: entry.dataset.sessionId || activeSessionId };
    const rect = sel.getRangeAt(0).getBoundingClientRect();
    const popup = $('annotation-popup');
    let left = rect.left, top = rect.bottom + 8;
    if (left + 300 > window.innerWidth - 280) left = window.innerWidth - 600;
    if (top + 160 > window.innerHeight) top = rect.top - 160;
    popup.style.left = Math.max(8, left) + 'px'; popup.style.top = top + 'px';
    $('popup-preview').textContent = txt.length > 80 ? txt.slice(0,80)+'...' : txt;
    popup.classList.add('visible'); $('popup-comment').focus();
  });

  $('popup-cancel').addEventListener('click', hidePopup);
  $('popup-submit').addEventListener('click', submitAnnotation);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { hidePopup(); closeConfigModal(); }
    if (e.key === 'Enter' && e.metaKey && $('annotation-popup').classList.contains('visible')) submitAnnotation();
  });
  // Close config modal on overlay click
  $('config-modal').addEventListener('click', (e) => {
    if (e.target === $('config-modal')) closeConfigModal();
  });

  async function submitAnnotation() {
    const comment = $('popup-comment').value.trim();
    if (!comment || !pendingSelection) return;
    await fetch(`${API}/api/annotate`, { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ sessionId: pendingSelection.sessionId, responseId: pendingSelection.responseId, selectedText: pendingSelection.text, comment })
    });
    hidePopup(); window.getSelection().removeAllRanges();
  }

  function hidePopup() { $('annotation-popup').classList.remove('visible'); $('popup-comment').value = ''; pendingSelection = null; }

  // === Copy Code ===
  function copyCode(btn) {
    const code = btn.dataset.code.replace(/&quot;/g, '"').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&');
    navigator.clipboard.writeText(code).then(() => {
      btn.textContent = 'copied'; btn.classList.add('copied');
      setTimeout(() => { btn.textContent = 'copy'; btn.classList.remove('copied'); }, 1500);
    });
  }

  // === Animated Numbers ===
  // Ease-out cubic: decelerates into final value
  function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

  // Smoothly animate a numeric value between old and new
  // el: DOM element with class="animated-num" and data-raw-value
  // formatter: function(rawNumber) => display string (e.g. formatTokens)
  function animateValue(el, oldVal, newVal, duration, formatter) {
    if (oldVal === newVal) return;
    // Cancel any in-flight animation on this element
    if (el._animFrame) cancelAnimationFrame(el._animFrame);

    const startTime = performance.now();
    const delta = newVal - oldVal;

    function tick(now) {
      const elapsed = now - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const eased = easeOutCubic(progress);
      const current = Math.round(oldVal + delta * eased);
      el.textContent = formatter(current);
      if (progress < 1) {
        el._animFrame = requestAnimationFrame(tick);
      } else {
        el.textContent = formatter(newVal);
        el._animFrame = null;
      }
    }
    el._animFrame = requestAnimationFrame(tick);
  }

  // Update an animated-num span: reads old data-raw-value, sets new, animates
  function updateAnimatedNum(el, newRaw, formatter, duration) {
    if (!el) return;
    duration = duration || 500;
    const oldRaw = parseInt(el.getAttribute('data-raw-value') || '0', 10) || 0;
    el.setAttribute('data-raw-value', String(newRaw));
    if (oldRaw === newRaw) return;
    animateValue(el, oldRaw, newRaw, duration, formatter);
  }

  // === Utils ===
  function $(id) { return document.getElementById(id); }
  function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
  function scrollBottom() { const a = $('responses-area'); a.scrollTop = a.scrollHeight; }
  function updateStatus() { $('status-sessions').textContent = `${sessions.size} session${sessions.size!==1?'s':''}`; }
  function formatTokens(n) { if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'K'; return String(n); }
  function formatNum(n) { if (n >= 1e6) return (n/1e6).toFixed(1)+'M'; if (n >= 1e3) return (n/1e3).toFixed(1)+'K'; return String(n); }

  $('responses-area').addEventListener('scroll', (e) => {
    const t = e.target; autoScroll = (t.scrollHeight - t.scrollTop - t.clientHeight) < 100;
  });

  connectWS();
</script>
</body>
</html>
